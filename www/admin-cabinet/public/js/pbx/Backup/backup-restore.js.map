{"version":3,"sources":["../../src/Backup/backup-restore.js"],"names":["restoreWorker","timeOut","timeOutHandle","$submitButton","$","waitRestoreId","undefined","$progressBar","$ajaxMessagesDiv","restoreIsProcessing","$formObj","formAlreadyBuilded","initialize","restartWorker","window","clearTimeout","timeoutHandle","worker","PbxApi","BackupGetFilesList","cbAfterGetFiles","setTimeout","response","length","removeClass","percentOfTotal","each","key","value","pid_recover","id","progress_recover","total","progress","duration","percent","parseInt","text","active","config","configKey","configValue","locLabel","html","globalTranslate","prepend","checkbox","onChange","onChangeCheckbox","formResult","form","options","Object","entries","addClass","restoreBackup","$deleteButton","$restoreModalForm","currentBackupId","location","pathname","split","modal","on","e","preventDefault","params","closable","onDeny","onApprove","ConfigWorker","stopConfigWorker","BackupRecover","cbAfterRestore","BackupDeleteFile","cbAfterDeleteFile","globalRootUrl","document","ready"],"mappings":"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","sourcesContent":["/*\n * Copyright (C) MIKO LLC - All Rights Reserved\n * Unauthorized copying of this file, via any medium is strictly prohibited\n * Proprietary and confidential\n * Written by Nikolay Beketov, 6 2018\n *\n */\n\n/* global PbxApi, ConfigWorker, globalTranslate, globalRootUrl */\n\n\nconst restoreWorker = {\n\ttimeOut: 3000,\n\ttimeOutHandle: '',\n\t$submitButton: $('#submitbutton'),\n\twaitRestoreId: undefined,\n\t$progressBar: $('#restore-progress-bar'),\n\t$ajaxMessagesDiv: $('#ajax-messages'),\n\trestoreIsProcessing: false,\n\t$formObj: $('#backup-restore-form'),\n\tformAlreadyBuilded: false,\n\tinitialize(waitRestoreId) {\n\t\trestoreWorker.waitRestoreId = waitRestoreId;\n\t\t// Запустим обновление статуса восстановления резервной копии\n\t\trestoreWorker.restartWorker();\n\t},\n\trestartWorker() {\n\t\twindow.clearTimeout(restoreWorker.timeoutHandle);\n\t\trestoreWorker.worker();\n\t},\n\tworker() {\n\t\tPbxApi.BackupGetFilesList(restoreWorker.cbAfterGetFiles);\n\t\trestoreWorker.timeoutHandle = window.setTimeout(restoreWorker.worker, restoreWorker.timeOut);\n\t},\n\tcbAfterGetFiles(response) {\n\t\tif (response.length === 0 || response === false) {\n\t\t\twindow.clearTimeout(restoreWorker.timeoutHandle);\n\t\t\trestoreWorker.$submitButton.removeClass('loading');\n\t\t} else {\n\t\t\tlet percentOfTotal = 0;\n\t\t\t$.each(response, (key, value) => {\n\t\t\t\trestoreWorker.restoreIsProcessing = (value.pid_recover.length > 0) || restoreWorker.restoreIsProcessing;\n\t\t\t\tif (restoreWorker.waitRestoreId === undefined && value.pid_recover.length > 0) {\n\t\t\t\t\trestoreWorker.waitRestoreId = value.id;\n\t\t\t\t}\n\t\t\t\tif (restoreWorker.waitRestoreId === value.id && restoreWorker.restoreIsProcessing > 0) {\n\t\t\t\t\tpercentOfTotal = 100 * (value.progress_recover / value.total);\n\n\t\t\t\t\trestoreWorker.$progressBar.progress({\n\t\t\t\t\t\tduration: value.progress_recover,\n\t\t\t\t\t\ttotal: value.total,\n\t\t\t\t\t\tpercent: parseInt(percentOfTotal, 10),\n\t\t\t\t\t\ttext: {\n\t\t\t\t\t\t\tactive: '{value} of {total} done',\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\tif (value.progress_recover === value.total) {\n\t\t\t\t\t\trestoreWorker.$submitButton.removeClass('loading');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Построим форму с чекбоксами\n\t\t\t\tif (restoreWorker.waitRestoreId === value.id) {\n\t\t\t\t\tif (!restoreWorker.formAlreadyBuilded) {\n\t\t\t\t\t\t$.each(value.config, (configKey, configValue) => {\n\t\t\t\t\t\t\tif (configValue === '1') {\n\t\t\t\t\t\t\t\tconst locLabel = `bkp_${configKey}`;\n\t\t\t\t\t\t\t\tlet html = '<div class=\"ui segment\"><div class=\"field\"><div class=\"ui toggle checkbox\">';\n\t\t\t\t\t\t\t\thtml += `<input type=\"checkbox\" name=\"${configKey}\" checked = \"checked\" class=\"hidden\"/>`;\n\t\t\t\t\t\t\t\thtml += `<label>${globalTranslate[locLabel]}</label>`;\n\t\t\t\t\t\t\t\thtml += '</div></div></div>';\n\t\t\t\t\t\t\t\trestoreWorker.$formObj.prepend(html);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\t$('.checkbox').checkbox({\n\t\t\t\t\t\t\tonChange: restoreWorker.onChangeCheckbox,\n\t\t\t\t\t\t});\n\t\t\t\t\t\trestoreWorker.formAlreadyBuilded = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\tif (restoreWorker.restoreIsProcessing === false) {\n\t\t\t\twindow.clearTimeout(restoreWorker.timeoutHandle);\n\t\t\t}\n\t\t}\n\t},\n\t/**\n\t * При выключении всех чекбоксов отключить кнопку\n\t */\n\tonChangeCheckbox() {\n\t\tconst formResult = restoreWorker.$formObj.form('get values');\n\t\tconst options = {};\n\t\t$.each(formResult, (key, value) => {\n\t\t\tif (value) {\n\t\t\t\toptions[key] = '1';\n\t\t\t}\n\t\t});\n\t\tif (Object.entries(options).length === 0) {\n\t\t\trestoreWorker.$submitButton.addClass('disabled');\n\t\t} else {\n\t\t\trestoreWorker.$submitButton.removeClass('disabled');\n\t\t}\n\t},\n};\n\nconst restoreBackup = {\n\t$progressBar: $('#restore-progress-bar'),\n\t$formObj: $('#backup-restore-form'),\n\t$submitButton: $('#submitbutton'),\n\t$deleteButton: $('#deletebutton'),\n\t$ajaxMessagesDiv: $('#ajax-messages'),\n\t$restoreModalForm: $('#restore-modal-form'),\n\tcurrentBackupId: window.location.pathname.split('/')[4],\n\tinitialize() {\n\t\trestoreBackup.$restoreModalForm.modal();\n\t\trestoreBackup.$submitButton.on('click', (e) => {\n\t\t\te.preventDefault();\n\t\t\tif (restoreWorker.restoreIsProcessing) return;\n\t\t\tconst formResult = restoreBackup.$formObj.form('get values');\n\t\t\tconst options = {};\n\t\t\t$.each(formResult, (key, value) => {\n\t\t\t\tif (value) {\n\t\t\t\t\toptions[key] = '1';\n\t\t\t\t}\n\t\t\t});\n\t\t\tif (Object.entries(options).length > 0) {\n\t\t\t\tconst params = {\n\t\t\t\t\tid: restoreBackup.currentBackupId,\n\t\t\t\t\toptions,\n\t\t\t\t};\n\t\t\t\trestoreBackup.$restoreModalForm\n\t\t\t\t\t.modal({\n\t\t\t\t\t\tclosable: false,\n\t\t\t\t\t\tonDeny: () => true,\n\t\t\t\t\t\tonApprove: () => {\n\t\t\t\t\t\t\trestoreWorker.$submitButton.addClass('loading');\n\t\t\t\t\t\t\trestoreWorker.restoreIsProcessing = true;\n\t\t\t\t\t\t\tConfigWorker.stopConfigWorker();\n\t\t\t\t\t\t\tPbxApi.BackupRecover(params, restoreBackup.cbAfterRestore);\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t},\n\t\t\t\t\t})\n\t\t\t\t\t.modal('show');\n\t\t\t}\n\t\t});\n\t\trestoreBackup.$deleteButton.on('click', (e) => {\n\t\t\te.preventDefault();\n\t\t\tif (restoreWorker.restoreIsProcessing) return;\n\t\t\tPbxApi.BackupDeleteFile(restoreBackup.currentBackupId, restoreBackup.cbAfterDeleteFile);\n\t\t});\n\t\trestoreWorker.initialize(restoreBackup.currentBackupId);\n\t},\n\tcbAfterRestore() {\n\t\trestoreWorker.initialize(restoreBackup.currentBackupId);\n\t},\n\tcbAfterDeleteFile(response) {\n\t\tif (response) {\n\t\t\twindow.location = `${globalRootUrl}/backup/index`;\n\t\t}\n\t},\n};\n\n\n$(document).ready(() => {\n\trestoreBackup.initialize();\n});\n\n"],"file":"backup-restore.js"}