{"version":3,"sources":["../../src/Backup/backup-restore.js"],"names":["restoreWorker","timeOut","timeOutHandle","$submitButton","$","waitRestoreId","undefined","$progressBar","restoreIsProcessing","$formObj","formAlreadyBuilded","initialize","restartWorker","window","clearTimeout","timeoutHandle","worker","PbxApi","BackupGetFilesList","cbAfterGetFiles","setTimeout","response","length","removeClass","percentOfTotal","each","key","value","pid_recover","id","progress_recover","total","progress","duration","percent","parseInt","text","active","config","configKey","configValue","locLabel","html","globalTranslate","prepend","checkbox","onChange","onChangeCheckbox","formResult","form","options","Object","entries","addClass","restoreBackup","$deleteButton","$restoreModalForm","currentBackupId","location","pathname","split","modal","on","e","preventDefault","params","closable","onDeny","onApprove","ConfigWorker","stopConfigWorker","BackupRecover","cbAfterRestore","BackupDeleteFile","cbAfterDeleteFile","globalRootUrl","document","ready"],"mappings":"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","sourcesContent":["/*\n * Copyright (C) MIKO LLC - All Rights Reserved\n * Unauthorized copying of this file, via any medium is strictly prohibited\n * Proprietary and confidential\n * Written by Nikolay Beketov, 6 2018\n *\n */\n\n/* global PbxApi, ConfigWorker, globalTranslate, globalRootUrl */\n\n\nconst restoreWorker = {\n\ttimeOut: 3000,\n\ttimeOutHandle: '',\n\t$submitButton: $('#submitbutton'),\n\twaitRestoreId: undefined,\n\t$progressBar: $('#restore-progress-bar'),\n\trestoreIsProcessing: false,\n\t$formObj: $('#backup-restore-form'),\n\tformAlreadyBuilded: false,\n\tinitialize(waitRestoreId) {\n\t\trestoreWorker.waitRestoreId = waitRestoreId;\n\t\t// Запустим обновление статуса восстановления резервной копии\n\t\trestoreWorker.restartWorker();\n\t},\n\trestartWorker() {\n\t\twindow.clearTimeout(restoreWorker.timeoutHandle);\n\t\trestoreWorker.worker();\n\t},\n\tworker() {\n\t\tPbxApi.BackupGetFilesList(restoreWorker.cbAfterGetFiles);\n\t\trestoreWorker.timeoutHandle = window.setTimeout(restoreWorker.worker, restoreWorker.timeOut);\n\t},\n\tcbAfterGetFiles(response) {\n\t\tif (response.length === 0 || response === false) {\n\t\t\twindow.clearTimeout(restoreWorker.timeoutHandle);\n\t\t\trestoreWorker.$submitButton.removeClass('loading');\n\t\t} else {\n\t\t\tlet percentOfTotal = 0;\n\t\t\t$.each(response, (key, value) => {\n\t\t\t\trestoreWorker.restoreIsProcessing = (value.pid_recover.length > 0) || restoreWorker.restoreIsProcessing;\n\t\t\t\tif (restoreWorker.waitRestoreId === undefined && value.pid_recover.length > 0) {\n\t\t\t\t\trestoreWorker.waitRestoreId = value.id;\n\t\t\t\t}\n\t\t\t\tif (restoreWorker.waitRestoreId === value.id && restoreWorker.restoreIsProcessing > 0) {\n\t\t\t\t\tpercentOfTotal = 100 * (value.progress_recover / value.total);\n\n\t\t\t\t\trestoreWorker.$progressBar.progress({\n\t\t\t\t\t\tduration: value.progress_recover,\n\t\t\t\t\t\ttotal: value.total,\n\t\t\t\t\t\tpercent: parseInt(percentOfTotal, 10),\n\t\t\t\t\t\ttext: {\n\t\t\t\t\t\t\tactive: '{value} of {total} done',\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\tif (value.progress_recover === value.total) {\n\t\t\t\t\t\trestoreWorker.$submitButton.removeClass('loading');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Построим форму с чекбоксами\n\t\t\t\tif (restoreWorker.waitRestoreId === value.id) {\n\t\t\t\t\tif (!restoreWorker.formAlreadyBuilded) {\n\t\t\t\t\t\t$.each(value.config, (configKey, configValue) => {\n\t\t\t\t\t\t\tif (configValue === '1') {\n\t\t\t\t\t\t\t\tconst locLabel = `bkp_${configKey}`;\n\t\t\t\t\t\t\t\tlet html = '<div class=\"ui segment\"><div class=\"field\"><div class=\"ui toggle checkbox\">';\n\t\t\t\t\t\t\t\thtml += `<input type=\"checkbox\" name=\"${configKey}\" checked = \"checked\" class=\"hidden\"/>`;\n\t\t\t\t\t\t\t\thtml += `<label>${globalTranslate[locLabel]}</label>`;\n\t\t\t\t\t\t\t\thtml += '</div></div></div>';\n\t\t\t\t\t\t\t\trestoreWorker.$formObj.prepend(html);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\t$('.checkbox').checkbox({\n\t\t\t\t\t\t\tonChange: restoreWorker.onChangeCheckbox,\n\t\t\t\t\t\t});\n\t\t\t\t\t\trestoreWorker.formAlreadyBuilded = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\tif (restoreWorker.restoreIsProcessing === false) {\n\t\t\t\twindow.clearTimeout(restoreWorker.timeoutHandle);\n\t\t\t}\n\t\t}\n\t},\n\t/**\n\t * При выключении всех чекбоксов отключить кнопку\n\t */\n\tonChangeCheckbox() {\n\t\tconst formResult = restoreWorker.$formObj.form('get values');\n\t\tconst options = {};\n\t\t$.each(formResult, (key, value) => {\n\t\t\tif (value) {\n\t\t\t\toptions[key] = '1';\n\t\t\t}\n\t\t});\n\t\tif (Object.entries(options).length === 0) {\n\t\t\trestoreWorker.$submitButton.addClass('disabled');\n\t\t} else {\n\t\t\trestoreWorker.$submitButton.removeClass('disabled');\n\t\t}\n\t},\n};\n\nconst restoreBackup = {\n\t$progressBar: $('#restore-progress-bar'),\n\t$formObj: $('#backup-restore-form'),\n\t$submitButton: $('#submitbutton'),\n\t$deleteButton: $('#deletebutton'),\n\t$restoreModalForm: $('#restore-modal-form'),\n\tcurrentBackupId: window.location.pathname.split('/')[4],\n\tinitialize() {\n\t\trestoreBackup.$restoreModalForm.modal();\n\t\trestoreBackup.$submitButton.on('click', (e) => {\n\t\t\te.preventDefault();\n\t\t\tif (restoreWorker.restoreIsProcessing) return;\n\t\t\tconst formResult = restoreBackup.$formObj.form('get values');\n\t\t\tconst options = {};\n\t\t\t$.each(formResult, (key, value) => {\n\t\t\t\tif (value) {\n\t\t\t\t\toptions[key] = '1';\n\t\t\t\t}\n\t\t\t});\n\t\t\tif (Object.entries(options).length > 0) {\n\t\t\t\tconst params = {\n\t\t\t\t\tid: restoreBackup.currentBackupId,\n\t\t\t\t\toptions,\n\t\t\t\t};\n\t\t\t\trestoreBackup.$restoreModalForm\n\t\t\t\t\t.modal({\n\t\t\t\t\t\tclosable: false,\n\t\t\t\t\t\tonDeny: () => true,\n\t\t\t\t\t\tonApprove: () => {\n\t\t\t\t\t\t\trestoreWorker.$submitButton.addClass('loading');\n\t\t\t\t\t\t\trestoreWorker.restoreIsProcessing = true;\n\t\t\t\t\t\t\tConfigWorker.stopConfigWorker();\n\t\t\t\t\t\t\tPbxApi.BackupRecover(params, restoreBackup.cbAfterRestore);\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t},\n\t\t\t\t\t})\n\t\t\t\t\t.modal('show');\n\t\t\t}\n\t\t});\n\t\trestoreBackup.$deleteButton.on('click', (e) => {\n\t\t\te.preventDefault();\n\t\t\tif (restoreWorker.restoreIsProcessing) return;\n\t\t\tPbxApi.BackupDeleteFile(restoreBackup.currentBackupId, restoreBackup.cbAfterDeleteFile);\n\t\t});\n\t\trestoreWorker.initialize(restoreBackup.currentBackupId);\n\t},\n\tcbAfterRestore() {\n\t\trestoreWorker.initialize(restoreBackup.currentBackupId);\n\t},\n\tcbAfterDeleteFile(response) {\n\t\tif (response) {\n\t\t\twindow.location = `${globalRootUrl}backup/index`;\n\t\t}\n\t},\n};\n\n\n$(document).ready(() => {\n\trestoreBackup.initialize();\n});\n\n"],"file":"backup-restore.js"}