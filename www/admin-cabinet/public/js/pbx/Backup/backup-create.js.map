{"version":3,"sources":["../../src/Backup/backup-create.js"],"names":["backupCreateWorker","timeOut","timeOutHandle","$submitButton","$","$stopCreateBackup","waitBackupId","$progressBar","backupIsPreparing","initialize","restartWorker","window","clearTimeout","timeoutHandle","worker","PbxApi","BackupGetFilesList","cbAfterGetFiles","setTimeout","response","length","show","removeClass","hide","percentOfTotal","each","key","value","pid","id","attr","progress","total","duration","percent","parseInt","text","active","location","globalRootUrl","createBackup","$formObj","addClass","checkbox","on","e","preventDefault","form","fields","validateRules","onSuccess","formData","sendData","Object","keys","forEach","BackupStart","cbAfterSendForm","ConfigWorker","stopConfigWorker","target","closest","BackupStop","BackupGetEstimatedSize","cbAfterGetEstimatedSize","$el","parent","find","undefined","html","document","ready"],"mappings":"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","sourcesContent":["/*\n * Copyright (C) MIKO LLC - All Rights Reserved\n * Unauthorized copying of this file, via any medium is strictly prohibited\n * Proprietary and confidential\n * Written by Nikolay Beketov, 6 2018\n *\n */\n\n/* global PbxApi, ConfigWorker, globalRootUrl */\n\nconst backupCreateWorker = {\n\ttimeOut: 3000,\n\ttimeOutHandle: '',\n\t$submitButton: $('#submitbutton'),\n\t$stopCreateBackup: $('#stopbackupbutton'),\n\twaitBackupId: '',\n\t$progressBar: $('#backup-progress-bar'),\n\tbackupIsPreparing: false,\n\tinitialize(waitBackupId) {\n\t\tbackupCreateWorker.waitBackupId = waitBackupId;\n\t\t// Запустим обновление статуса создания резервной копии\n\t\tbackupCreateWorker.restartWorker();\n\t},\n\trestartWorker() {\n\t\twindow.clearTimeout(backupCreateWorker.timeoutHandle);\n\t\tbackupCreateWorker.worker();\n\t},\n\tworker() {\n\t\tPbxApi.BackupGetFilesList(backupCreateWorker.cbAfterGetFiles);\n\t\tbackupCreateWorker.timeoutHandle = window.setTimeout(\n\t\t\tbackupCreateWorker.worker,\n\t\t\tbackupCreateWorker.timeOut,\n\t\t);\n\t},\n\tcbAfterGetFiles(response) {\n\t\tif (response.length === 0 || response === false) {\n\t\t\twindow.clearTimeout(backupCreateWorker.timeoutHandle);\n\t\t\tbackupCreateWorker.$submitButton.show();\n\t\t\tbackupCreateWorker.$submitButton.removeClass('loading');\n\t\t\tbackupCreateWorker.$stopCreateBackup.hide();\n\t\t} else {\n\t\t\t// [\"0\": {\n\t\t\t// \t\t\"date\": \"1530715058\",\n\t\t\t// \t\t\"size\": 13.66,\n\t\t\t// \t\t\"progress\": 10,\n\t\t\t// \t\t\"total\": 32,\n\t\t\t// \t\t\"config\": {\n\t\t\t// \t\t\t\"backup-config\": \"1\",\n\t\t\t// \t\t\t\"backup-records\": \"1\",\n\t\t\t// \t\t\t\"backup-cdr\": \"1\",\n\t\t\t// \t\t\t\"backup-sound-files\": \"1\"\n\t\t\t// \t\t},\n\t\t\t// \t\t\"pid\": \"\",\n\t\t\t// \t\t\"id\": \"backup_1530715058\"\n\t\t\t// }]\n\t\t\tlet percentOfTotal = 0;\n\t\t\t$.each(response, (key, value) => {\n\t\t\t\tif (backupCreateWorker.waitBackupId === '' && value.pid.length > 0) {\n\t\t\t\t\tbackupCreateWorker.waitBackupId = value.id;\n\t\t\t\t}\n\t\t\t\tif (backupCreateWorker.waitBackupId === value.id) {\n\t\t\t\t\tbackupCreateWorker.$submitButton.hide();\n\t\t\t\t\tbackupCreateWorker.$stopCreateBackup\n\t\t\t\t\t\t.attr('data-value', backupCreateWorker.waitBackupId)\n\t\t\t\t\t\t.show();\n\t\t\t\t\tpercentOfTotal = 100 * (value.progress / value.total);\n\n\t\t\t\t\tbackupCreateWorker.$progressBar.progress({\n\t\t\t\t\t\tduration: value.progress,\n\t\t\t\t\t\ttotal: value.total,\n\t\t\t\t\t\tpercent: parseInt(percentOfTotal, 10),\n\t\t\t\t\t\ttext: {\n\t\t\t\t\t\t\tactive: '{value} of {total} done',\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tif (value.total === value.progress && backupCreateWorker.backupIsPreparing) {\n\t\t\t\t\t\twindow.location = `${globalRootUrl}/backup/index`;\n\t\t\t\t\t}\n\t\t\t\t\tbackupCreateWorker.backupIsPreparing = (value.pid.length > 0);\n\t\t\t\t}\n\t\t\t});\n\t\t\tif (backupCreateWorker.backupIsPreparing === false) {\n\t\t\t\tbackupCreateWorker.$submitButton.show();\n\t\t\t\tbackupCreateWorker.$stopCreateBackup.hide();\n\t\t\t\tbackupCreateWorker.$submitButton.removeClass('loading');\n\t\t\t\twindow.clearTimeout(backupCreateWorker.timeoutHandle);\n\t\t\t}\n\t\t}\n\t},\n};\n\nconst createBackup = {\n\t$formObj: $('#backup-create-form'),\n\t$submitButton: $('#submitbutton'),\n\t$stopCreateBackup: $('#stopbackupbutton'),\n\tinitialize() {\n\t\tcreateBackup.$submitButton.addClass('loading');\n\t\tcreateBackup.$stopCreateBackup.hide();\n\t\t$('.checkbox').checkbox();\n\t\tcreateBackup.$submitButton.on('click', (e) => {\n\t\t\te.preventDefault();\n\t\t\tcreateBackup.$formObj\n\t\t\t\t.form({\n\t\t\t\t\ton: 'blur',\n\t\t\t\t\tfields: createBackup.validateRules,\n\t\t\t\t\tonSuccess() {\n\t\t\t\t\t\tconst formData = createBackup.$formObj.form('get values');\n\t\t\t\t\t\tconst sendData = {};\n\t\t\t\t\t\tObject.keys(formData).forEach((key) => {\n\t\t\t\t\t\t\tsendData[key] = (formData[key] === 'on') ? '1' : '0';\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbackupCreateWorker.backupIsPreparing = true;\n\t\t\t\t\t\tcreateBackup.$submitButton.addClass('loading');\n\t\t\t\t\t\tPbxApi.BackupStart(sendData, createBackup.cbAfterSendForm);\n\t\t\t\t\t\tConfigWorker.stopConfigWorker();\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\tcreateBackup.$formObj.form('validate form');\n\t\t});\n\t\tcreateBackup.$stopCreateBackup.on('click', (e) => {\n\t\t\te.preventDefault();\n\t\t\tconst id = $(e.target).closest('button').attr('data-value');\n\t\t\tPbxApi.BackupStop(id, createBackup.cbAfterSendForm);\n\t\t});\n\t\tbackupCreateWorker.initialize('');\n\t\tPbxApi.BackupGetEstimatedSize(createBackup.cbAfterGetEstimatedSize);\n\t},\n\tcbAfterSendForm(response) {\n\t\tif (response.length === 0 || response === false) {\n\t\t\tcreateBackup.$submitButton.removeClass('loading');\n\t\t} else {\n\t\t\tbackupCreateWorker.initialize(response);\n\t\t}\n\t},\n\tcbAfterGetEstimatedSize(response) {\n\t\tif (response.length === 0 || response === false) return;\n\t\t$.each(response, (key, value) => {\n\t\t\tconst $el = $(`#${key}`).parent().find('label');\n\t\t\tif ($el !== undefined) {\n\t\t\t\t$el.html(`${$el.html()} ( ${value} Mb )`);\n\t\t\t}\n\t\t});\n\t},\n};\n\n\n$(document).ready(() => {\n\tcreateBackup.initialize();\n});\n\n"],"file":"backup-create.js"}