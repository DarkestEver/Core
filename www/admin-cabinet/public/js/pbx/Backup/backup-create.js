"use strict";

/*
 * Copyright (C) MIKO LLC - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Nikolay Beketov, 12 2019
 *
 */

/* global PbxApi, globalRootUrl */
var backupCreateWorker = {
  timeOut: 3000,
  timeOutHandle: '',
  $submitButton: $('#submitbutton'),
  $stopCreateBackup: $('#stopbackupbutton'),
  waitBackupId: '',
  $progressBar: $('#backup-progress-bar'),
  backupIsPreparing: false,
  initialize: function () {
    function initialize(waitBackupId) {
      backupCreateWorker.waitBackupId = waitBackupId; // Запустим обновление статуса создания резервной копии

      backupCreateWorker.restartWorker();
    }

    return initialize;
  }(),
  restartWorker: function () {
    function restartWorker() {
      window.clearTimeout(backupCreateWorker.timeoutHandle);
      backupCreateWorker.worker();
    }

    return restartWorker;
  }(),
  worker: function () {
    function worker() {
      PbxApi.BackupGetFilesList(backupCreateWorker.cbAfterGetFiles);
      backupCreateWorker.timeoutHandle = window.setTimeout(backupCreateWorker.worker, backupCreateWorker.timeOut);
    }

    return worker;
  }(),
  cbAfterGetFiles: function () {
    function cbAfterGetFiles(response) {
      if (response.length === 0 || response === false) {
        window.clearTimeout(backupCreateWorker.timeoutHandle);
        backupCreateWorker.$submitButton.show();
        backupCreateWorker.$submitButton.removeClass('loading');
        backupCreateWorker.$stopCreateBackup.hide();
      } else {
        // ["0": {
        // 		"date": "1530715058",
        // 		"size": 13.66,
        // 		"progress": 10,
        // 		"total": 32,
        // 		"config": {
        // 			"backup-config": "1",
        // 			"backup-records": "1",
        // 			"backup-cdr": "1",
        // 			"backup-sound-files": "1"
        // 		},
        // 		"pid": "",
        // 		"id": "backup_1530715058"
        // }]
        var percentOfTotal = 0;
        $.each(response, function (key, value) {
          if (backupCreateWorker.waitBackupId === '' && value.pid.length > 0) {
            backupCreateWorker.waitBackupId = value.id;
          }

          if (backupCreateWorker.waitBackupId === value.id) {
            backupCreateWorker.$submitButton.hide();
            backupCreateWorker.$stopCreateBackup.attr('data-value', backupCreateWorker.waitBackupId).show();
            percentOfTotal = 100 * (value.progress / value.total);
            backupCreateWorker.$progressBar.progress({
              duration: value.progress,
              total: value.total,
              percent: parseInt(percentOfTotal, 10),
              text: {
                active: '{value} of {total} done'
              }
            });

            if (value.total === value.progress && backupCreateWorker.backupIsPreparing) {
              window.location = "".concat(globalRootUrl, "/backup/index");
            }

            backupCreateWorker.backupIsPreparing = value.pid.length > 0;
          }
        });

        if (backupCreateWorker.backupIsPreparing === false) {
          backupCreateWorker.$submitButton.show();
          backupCreateWorker.$stopCreateBackup.hide();
          backupCreateWorker.$submitButton.removeClass('loading');
          window.clearTimeout(backupCreateWorker.timeoutHandle);
        }
      }
    }

    return cbAfterGetFiles;
  }()
};
var createBackup = {
  $formObj: $('#backup-create-form'),
  $submitButton: $('#submitbutton'),
  $stopCreateBackup: $('#stopbackupbutton'),
  initialize: function () {
    function initialize() {
      createBackup.$submitButton.addClass('loading');
      createBackup.$stopCreateBackup.hide();
      $('.checkbox').checkbox();
      createBackup.$submitButton.on('click', function (e) {
        e.preventDefault();
        createBackup.$formObj.form({
          on: 'blur',
          fields: createBackup.validateRules,
          onSuccess: function () {
            function onSuccess() {
              var formData = createBackup.$formObj.form('get values');
              var sendData = {};
              Object.keys(formData).forEach(function (key) {
                sendData[key] = formData[key] === 'on' ? '1' : '0';
              });
              backupCreateWorker.backupIsPreparing = true;
              createBackup.$submitButton.addClass('loading');
              PbxApi.BackupStart(sendData, createBackup.cbAfterSendForm);
            }

            return onSuccess;
          }()
        });
        createBackup.$formObj.form('validate form');
      });
      createBackup.$stopCreateBackup.on('click', function (e) {
        e.preventDefault();
        var id = $(e.target).closest('button').attr('data-value');
        PbxApi.BackupStop(id, createBackup.cbAfterSendForm);
      });
      backupCreateWorker.initialize('');
      PbxApi.BackupGetEstimatedSize(createBackup.cbAfterGetEstimatedSize);
    }

    return initialize;
  }(),
  cbAfterSendForm: function () {
    function cbAfterSendForm(response) {
      if (response.length === 0 || response === false) {
        createBackup.$submitButton.removeClass('loading');
      } else {
        backupCreateWorker.initialize(response);
      }
    }

    return cbAfterSendForm;
  }(),
  cbAfterGetEstimatedSize: function () {
    function cbAfterGetEstimatedSize(response) {
      if (response.length === 0 || response === false) return;
      $.each(response, function (key, value) {
        var $el = $("#".concat(key)).parent().find('label');

        if ($el !== undefined) {
          $el.html("".concat($el.html(), " ( ").concat(value, " Mb )"));
        }
      });
    }

    return cbAfterGetEstimatedSize;
  }()
};
$(document).ready(function () {
  createBackup.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9CYWNrdXAvYmFja3VwLWNyZWF0ZS5qcyJdLCJuYW1lcyI6WyJiYWNrdXBDcmVhdGVXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsIiRzdWJtaXRCdXR0b24iLCIkIiwiJHN0b3BDcmVhdGVCYWNrdXAiLCJ3YWl0QmFja3VwSWQiLCIkcHJvZ3Jlc3NCYXIiLCJiYWNrdXBJc1ByZXBhcmluZyIsImluaXRpYWxpemUiLCJyZXN0YXJ0V29ya2VyIiwid2luZG93IiwiY2xlYXJUaW1lb3V0IiwidGltZW91dEhhbmRsZSIsIndvcmtlciIsIlBieEFwaSIsIkJhY2t1cEdldEZpbGVzTGlzdCIsImNiQWZ0ZXJHZXRGaWxlcyIsInNldFRpbWVvdXQiLCJyZXNwb25zZSIsImxlbmd0aCIsInNob3ciLCJyZW1vdmVDbGFzcyIsImhpZGUiLCJwZXJjZW50T2ZUb3RhbCIsImVhY2giLCJrZXkiLCJ2YWx1ZSIsInBpZCIsImlkIiwiYXR0ciIsInByb2dyZXNzIiwidG90YWwiLCJkdXJhdGlvbiIsInBlcmNlbnQiLCJwYXJzZUludCIsInRleHQiLCJhY3RpdmUiLCJsb2NhdGlvbiIsImdsb2JhbFJvb3RVcmwiLCJjcmVhdGVCYWNrdXAiLCIkZm9ybU9iaiIsImFkZENsYXNzIiwiY2hlY2tib3giLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImZvcm0iLCJmaWVsZHMiLCJ2YWxpZGF0ZVJ1bGVzIiwib25TdWNjZXNzIiwiZm9ybURhdGEiLCJzZW5kRGF0YSIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwiQmFja3VwU3RhcnQiLCJjYkFmdGVyU2VuZEZvcm0iLCJ0YXJnZXQiLCJjbG9zZXN0IiwiQmFja3VwU3RvcCIsIkJhY2t1cEdldEVzdGltYXRlZFNpemUiLCJjYkFmdGVyR2V0RXN0aW1hdGVkU2l6ZSIsIiRlbCIsInBhcmVudCIsImZpbmQiLCJ1bmRlZmluZWQiLCJodG1sIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7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S0FBTixFQUFnQjtBQUNoQyxZQUFNb0MsR0FBRyxHQUFHM0QsQ0FBQyxZQUFLc0IsR0FBTCxFQUFELENBQWFzQyxNQUFiLEdBQXNCQyxJQUF0QixDQUEyQixPQUEzQixDQUFaOztBQUNBLFlBQUlGLEdBQUcsS0FBS0csU0FBWixFQUF1QjtBQUN0QkgsVUFBQUEsR0FBRyxDQUFDSSxJQUFKLFdBQVlKLEdBQUcsQ0FBQ0ksSUFBSixFQUFaLGdCQUE0QnhDLEtBQTVCO0FBQ0E7QUFDRCxPQUxEO0FBTUE7O0FBbERtQjtBQUFBO0FBQUEsQ0FBckI7QUFzREF2QixDQUFDLENBQUNnRSxRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3ZCN0IsRUFBQUEsWUFBWSxDQUFDL0IsVUFBYjtBQUNBLENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChDKSBNSUtPIExMQyAtIEFsbCBSaWdodHMgUmVzZXJ2ZWRcbiAqIFVuYXV0aG9yaXplZCBjb3B5aW5nIG9mIHRoaXMgZmlsZSwgdmlhIGFueSBtZWRpdW0gaXMgc3RyaWN0bHkgcHJvaGliaXRlZFxuICogUHJvcHJpZXRhcnkgYW5kIGNvbmZpZGVudGlhbFxuICogV3JpdHRlbiBieSBOaWtvbGF5IEJla2V0b3YsIDEyIDIwMTlcbiAqXG4gKi9cblxuLyogZ2xvYmFsIFBieEFwaSwgZ2xvYmFsUm9vdFVybCAqL1xuXG5jb25zdCBiYWNrdXBDcmVhdGVXb3JrZXIgPSB7XG5cdHRpbWVPdXQ6IDMwMDAsXG5cdHRpbWVPdXRIYW5kbGU6ICcnLFxuXHQkc3VibWl0QnV0dG9uOiAkKCcjc3VibWl0YnV0dG9uJyksXG5cdCRzdG9wQ3JlYXRlQmFja3VwOiAkKCcjc3RvcGJhY2t1cGJ1dHRvbicpLFxuXHR3YWl0QmFja3VwSWQ6ICcnLFxuXHQkcHJvZ3Jlc3NCYXI6ICQoJyNiYWNrdXAtcHJvZ3Jlc3MtYmFyJyksXG5cdGJhY2t1cElzUHJlcGFyaW5nOiBmYWxzZSxcblx0aW5pdGlhbGl6ZSh3YWl0QmFja3VwSWQpIHtcblx0XHRiYWNrdXBDcmVhdGVXb3JrZXIud2FpdEJhY2t1cElkID0gd2FpdEJhY2t1cElkO1xuXHRcdC8vINCX0LDQv9GD0YHRgtC40Lwg0L7QsdC90L7QstC70LXQvdC40LUg0YHRgtCw0YLRg9GB0LAg0YHQvtC30LTQsNC90LjRjyDRgNC10LfQtdGA0LLQvdC+0Lkg0LrQvtC/0LjQuFxuXHRcdGJhY2t1cENyZWF0ZVdvcmtlci5yZXN0YXJ0V29ya2VyKCk7XG5cdH0sXG5cdHJlc3RhcnRXb3JrZXIoKSB7XG5cdFx0d2luZG93LmNsZWFyVGltZW91dChiYWNrdXBDcmVhdGVXb3JrZXIudGltZW91dEhhbmRsZSk7XG5cdFx0YmFja3VwQ3JlYXRlV29ya2VyLndvcmtlcigpO1xuXHR9LFxuXHR3b3JrZXIoKSB7XG5cdFx0UGJ4QXBpLkJhY2t1cEdldEZpbGVzTGlzdChiYWNrdXBDcmVhdGVXb3JrZXIuY2JBZnRlckdldEZpbGVzKTtcblx0XHRiYWNrdXBDcmVhdGVXb3JrZXIudGltZW91dEhhbmRsZSA9IHdpbmRvdy5zZXRUaW1lb3V0KFxuXHRcdFx0YmFja3VwQ3JlYXRlV29ya2VyLndvcmtlcixcblx0XHRcdGJhY2t1cENyZWF0ZVdvcmtlci50aW1lT3V0LFxuXHRcdCk7XG5cdH0sXG5cdGNiQWZ0ZXJHZXRGaWxlcyhyZXNwb25zZSkge1xuXHRcdGlmIChyZXNwb25zZS5sZW5ndGggPT09IDAgfHwgcmVzcG9uc2UgPT09IGZhbHNlKSB7XG5cdFx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KGJhY2t1cENyZWF0ZVdvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHRcdGJhY2t1cENyZWF0ZVdvcmtlci4kc3VibWl0QnV0dG9uLnNob3coKTtcblx0XHRcdGJhY2t1cENyZWF0ZVdvcmtlci4kc3VibWl0QnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHRiYWNrdXBDcmVhdGVXb3JrZXIuJHN0b3BDcmVhdGVCYWNrdXAuaGlkZSgpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHQvLyBbXCIwXCI6IHtcblx0XHRcdC8vIFx0XHRcImRhdGVcIjogXCIxNTMwNzE1MDU4XCIsXG5cdFx0XHQvLyBcdFx0XCJzaXplXCI6IDEzLjY2LFxuXHRcdFx0Ly8gXHRcdFwicHJvZ3Jlc3NcIjogMTAsXG5cdFx0XHQvLyBcdFx0XCJ0b3RhbFwiOiAzMixcblx0XHRcdC8vIFx0XHRcImNvbmZpZ1wiOiB7XG5cdFx0XHQvLyBcdFx0XHRcImJhY2t1cC1jb25maWdcIjogXCIxXCIsXG5cdFx0XHQvLyBcdFx0XHRcImJhY2t1cC1yZWNvcmRzXCI6IFwiMVwiLFxuXHRcdFx0Ly8gXHRcdFx0XCJiYWNrdXAtY2RyXCI6IFwiMVwiLFxuXHRcdFx0Ly8gXHRcdFx0XCJiYWNrdXAtc291bmQtZmlsZXNcIjogXCIxXCJcblx0XHRcdC8vIFx0XHR9LFxuXHRcdFx0Ly8gXHRcdFwicGlkXCI6IFwiXCIsXG5cdFx0XHQvLyBcdFx0XCJpZFwiOiBcImJhY2t1cF8xNTMwNzE1MDU4XCJcblx0XHRcdC8vIH1dXG5cdFx0XHRsZXQgcGVyY2VudE9mVG90YWwgPSAwO1xuXHRcdFx0JC5lYWNoKHJlc3BvbnNlLCAoa2V5LCB2YWx1ZSkgPT4ge1xuXHRcdFx0XHRpZiAoYmFja3VwQ3JlYXRlV29ya2VyLndhaXRCYWNrdXBJZCA9PT0gJycgJiYgdmFsdWUucGlkLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0XHRiYWNrdXBDcmVhdGVXb3JrZXIud2FpdEJhY2t1cElkID0gdmFsdWUuaWQ7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKGJhY2t1cENyZWF0ZVdvcmtlci53YWl0QmFja3VwSWQgPT09IHZhbHVlLmlkKSB7XG5cdFx0XHRcdFx0YmFja3VwQ3JlYXRlV29ya2VyLiRzdWJtaXRCdXR0b24uaGlkZSgpO1xuXHRcdFx0XHRcdGJhY2t1cENyZWF0ZVdvcmtlci4kc3RvcENyZWF0ZUJhY2t1cFxuXHRcdFx0XHRcdFx0LmF0dHIoJ2RhdGEtdmFsdWUnLCBiYWNrdXBDcmVhdGVXb3JrZXIud2FpdEJhY2t1cElkKVxuXHRcdFx0XHRcdFx0LnNob3coKTtcblx0XHRcdFx0XHRwZXJjZW50T2ZUb3RhbCA9IDEwMCAqICh2YWx1ZS5wcm9ncmVzcyAvIHZhbHVlLnRvdGFsKTtcblxuXHRcdFx0XHRcdGJhY2t1cENyZWF0ZVdvcmtlci4kcHJvZ3Jlc3NCYXIucHJvZ3Jlc3Moe1xuXHRcdFx0XHRcdFx0ZHVyYXRpb246IHZhbHVlLnByb2dyZXNzLFxuXHRcdFx0XHRcdFx0dG90YWw6IHZhbHVlLnRvdGFsLFxuXHRcdFx0XHRcdFx0cGVyY2VudDogcGFyc2VJbnQocGVyY2VudE9mVG90YWwsIDEwKSxcblx0XHRcdFx0XHRcdHRleHQ6IHtcblx0XHRcdFx0XHRcdFx0YWN0aXZlOiAne3ZhbHVlfSBvZiB7dG90YWx9IGRvbmUnLFxuXHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRpZiAodmFsdWUudG90YWwgPT09IHZhbHVlLnByb2dyZXNzICYmIGJhY2t1cENyZWF0ZVdvcmtlci5iYWNrdXBJc1ByZXBhcmluZykge1xuXHRcdFx0XHRcdFx0d2luZG93LmxvY2F0aW9uID0gYCR7Z2xvYmFsUm9vdFVybH0vYmFja3VwL2luZGV4YDtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0YmFja3VwQ3JlYXRlV29ya2VyLmJhY2t1cElzUHJlcGFyaW5nID0gKHZhbHVlLnBpZC5sZW5ndGggPiAwKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0XHRpZiAoYmFja3VwQ3JlYXRlV29ya2VyLmJhY2t1cElzUHJlcGFyaW5nID09PSBmYWxzZSkge1xuXHRcdFx0XHRiYWNrdXBDcmVhdGVXb3JrZXIuJHN1Ym1pdEJ1dHRvbi5zaG93KCk7XG5cdFx0XHRcdGJhY2t1cENyZWF0ZVdvcmtlci4kc3RvcENyZWF0ZUJhY2t1cC5oaWRlKCk7XG5cdFx0XHRcdGJhY2t1cENyZWF0ZVdvcmtlci4kc3VibWl0QnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHRcdHdpbmRvdy5jbGVhclRpbWVvdXQoYmFja3VwQ3JlYXRlV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdFx0fVxuXHRcdH1cblx0fSxcbn07XG5cbmNvbnN0IGNyZWF0ZUJhY2t1cCA9IHtcblx0JGZvcm1PYmo6ICQoJyNiYWNrdXAtY3JlYXRlLWZvcm0nKSxcblx0JHN1Ym1pdEJ1dHRvbjogJCgnI3N1Ym1pdGJ1dHRvbicpLFxuXHQkc3RvcENyZWF0ZUJhY2t1cDogJCgnI3N0b3BiYWNrdXBidXR0b24nKSxcblx0aW5pdGlhbGl6ZSgpIHtcblx0XHRjcmVhdGVCYWNrdXAuJHN1Ym1pdEJ1dHRvbi5hZGRDbGFzcygnbG9hZGluZycpO1xuXHRcdGNyZWF0ZUJhY2t1cC4kc3RvcENyZWF0ZUJhY2t1cC5oaWRlKCk7XG5cdFx0JCgnLmNoZWNrYm94JykuY2hlY2tib3goKTtcblx0XHRjcmVhdGVCYWNrdXAuJHN1Ym1pdEJ1dHRvbi5vbignY2xpY2snLCAoZSkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0Y3JlYXRlQmFja3VwLiRmb3JtT2JqXG5cdFx0XHRcdC5mb3JtKHtcblx0XHRcdFx0XHRvbjogJ2JsdXInLFxuXHRcdFx0XHRcdGZpZWxkczogY3JlYXRlQmFja3VwLnZhbGlkYXRlUnVsZXMsXG5cdFx0XHRcdFx0b25TdWNjZXNzKCkge1xuXHRcdFx0XHRcdFx0Y29uc3QgZm9ybURhdGEgPSBjcmVhdGVCYWNrdXAuJGZvcm1PYmouZm9ybSgnZ2V0IHZhbHVlcycpO1xuXHRcdFx0XHRcdFx0Y29uc3Qgc2VuZERhdGEgPSB7fTtcblx0XHRcdFx0XHRcdE9iamVjdC5rZXlzKGZvcm1EYXRhKS5mb3JFYWNoKChrZXkpID0+IHtcblx0XHRcdFx0XHRcdFx0c2VuZERhdGFba2V5XSA9IChmb3JtRGF0YVtrZXldID09PSAnb24nKSA/ICcxJyA6ICcwJztcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0YmFja3VwQ3JlYXRlV29ya2VyLmJhY2t1cElzUHJlcGFyaW5nID0gdHJ1ZTtcblx0XHRcdFx0XHRcdGNyZWF0ZUJhY2t1cC4kc3VibWl0QnV0dG9uLmFkZENsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHRcdFx0XHRQYnhBcGkuQmFja3VwU3RhcnQoc2VuZERhdGEsIGNyZWF0ZUJhY2t1cC5jYkFmdGVyU2VuZEZvcm0pO1xuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdH0pO1xuXHRcdFx0Y3JlYXRlQmFja3VwLiRmb3JtT2JqLmZvcm0oJ3ZhbGlkYXRlIGZvcm0nKTtcblx0XHR9KTtcblx0XHRjcmVhdGVCYWNrdXAuJHN0b3BDcmVhdGVCYWNrdXAub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdGNvbnN0IGlkID0gJChlLnRhcmdldCkuY2xvc2VzdCgnYnV0dG9uJykuYXR0cignZGF0YS12YWx1ZScpO1xuXHRcdFx0UGJ4QXBpLkJhY2t1cFN0b3AoaWQsIGNyZWF0ZUJhY2t1cC5jYkFmdGVyU2VuZEZvcm0pO1xuXHRcdH0pO1xuXHRcdGJhY2t1cENyZWF0ZVdvcmtlci5pbml0aWFsaXplKCcnKTtcblx0XHRQYnhBcGkuQmFja3VwR2V0RXN0aW1hdGVkU2l6ZShjcmVhdGVCYWNrdXAuY2JBZnRlckdldEVzdGltYXRlZFNpemUpO1xuXHR9LFxuXHRjYkFmdGVyU2VuZEZvcm0ocmVzcG9uc2UpIHtcblx0XHRpZiAocmVzcG9uc2UubGVuZ3RoID09PSAwIHx8IHJlc3BvbnNlID09PSBmYWxzZSkge1xuXHRcdFx0Y3JlYXRlQmFja3VwLiRzdWJtaXRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0YmFja3VwQ3JlYXRlV29ya2VyLmluaXRpYWxpemUocmVzcG9uc2UpO1xuXHRcdH1cblx0fSxcblx0Y2JBZnRlckdldEVzdGltYXRlZFNpemUocmVzcG9uc2UpIHtcblx0XHRpZiAocmVzcG9uc2UubGVuZ3RoID09PSAwIHx8IHJlc3BvbnNlID09PSBmYWxzZSkgcmV0dXJuO1xuXHRcdCQuZWFjaChyZXNwb25zZSwgKGtleSwgdmFsdWUpID0+IHtcblx0XHRcdGNvbnN0ICRlbCA9ICQoYCMke2tleX1gKS5wYXJlbnQoKS5maW5kKCdsYWJlbCcpO1xuXHRcdFx0aWYgKCRlbCAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdCRlbC5odG1sKGAkeyRlbC5odG1sKCl9ICggJHt2YWx1ZX0gTWIgKWApO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9LFxufTtcblxuXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG5cdGNyZWF0ZUJhY2t1cC5pbml0aWFsaXplKCk7XG59KTtcblxuIl19