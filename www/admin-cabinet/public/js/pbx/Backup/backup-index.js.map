{"version":3,"sources":["../../src/Backup/backup-index.js"],"names":["backupIndex","$templateRow","$","$dummy","$uploadButton","$progressBar","$body","$ajaxMessagesDiv","initialize","hide","PbxApi","BackupGetFilesList","cbBackupGetFilesListAfterResponse","on","e","preventDefault","id","target","closest","attr","BackupDownloadFile","hasClass","parents","click","filename","files","name","parent","val","ConfigWorker","stopConfigWorker","data","addClass","BackupUpload","cbUploadFileProcessing","response","length","removeClass","remove","after","globalTranslate","bkp_UploadError","show","progress","percent","parseInt","setTimeout","window","location","globalRootUrl","SystemReboot","bkp_SettingsRestoredWaitReboot","each","key","value","$newRow","clone","arhDate","Date","date","find","html","toLocaleString","size","pid","pid_recover","index","obj","percentOfTotal","total","appendTo","document","ready"],"mappings":"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","sourcesContent":["/*\n * Copyright (C) MIKO LLC - All Rights Reserved\n * Unauthorized copying of this file, via any medium is strictly prohibited\n * Proprietary and confidential\n * Written by Nikolay Beketov, 6 2018\n *\n */\n\n/* global PbxApi, globalTranslate, ConfigWorker, globalRootUrl */\n\nconst backupIndex = {\n\t$templateRow: $('#backup-template-row'),\n\t$dummy: $('#dummy-row'),\n\t$uploadButton: $('#uploadbtn'),\n\t$progressBar: $('#upload-progress-bar'),\n\t$body: $('body'),\n\t$ajaxMessagesDiv: $('#ajax-messages'),\n\tinitialize() {\n\t\tbackupIndex.$progressBar.hide();\n\t\tPbxApi.BackupGetFilesList(backupIndex.cbBackupGetFilesListAfterResponse);\n\t\tbackupIndex.$body.on('click', 'a.download', (e) => {\n\t\t\te.preventDefault();\n\t\t\tconst id = $(e.target).closest('a').attr('data-value');\n\t\t\tPbxApi.BackupDownloadFile(id);\n\t\t});\n\n\t\tbackupIndex.$uploadButton.on('click', (e) => {\n\t\t\tif ($(e.target).closest('button').hasClass('loading')) {\n\t\t\t\te.preventDefault();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t$('input:file', $(e.target).parents()).click();\n\t\t});\n\n\t\t$('input:file').on('change', (e) => {\n\t\t\tconst filename = e.target.files[0].name;\n\t\t\t$('input:text', $(e.target).parent()).val(filename);\n\t\t\tConfigWorker.stopConfigWorker();\n\t\t\tconst data = $('input:file')[0].files[0];\n\t\t\tbackupIndex.$uploadButton.addClass('loading');\n\t\t\tPbxApi.BackupUpload(data, backupIndex.cbUploadFileProcessing);\n\t\t});\n\t},\n\t/**\n\t * Обработка процесса загрузки файла бекапа на станцию\n\t */\n\tcbUploadFileProcessing(response) {\n\t\tif (response.length === 0 || response === false) {\n\t\t\tbackupIndex.$uploadButton.removeClass('loading');\n\t\t\t$('.ui.message.ajax').remove();\n\t\t\tbackupIndex.$ajaxMessagesDiv.after(`<div class=\"ui error message ajax\">${globalTranslate.bkp_UploadError}</div>`);\n\t\t} else if (response.function === 'upload_progress') {\n\t\t\tbackupIndex.$uploadButton.addClass('loading');\n\t\t\tbackupIndex.$progressBar.show();\n\t\t\tbackupIndex.$progressBar.progress({\n\t\t\t\tpercent: parseInt(response.percent, 10),\n\t\t\t});\n\t\t\tif (response.percent === 100) {\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\twindow.location = `${globalRootUrl}/backup/index`;\n\t\t\t\t}, 5000);\n\t\t\t}\n\t\t} else if (response.function === 'convert_config') { // TODO: тут конфиг происходит сразу при загрузке, не хорошо\n\t\t\tbackupIndex.$uploadButton.addClass('loading');\n\t\t\tPbxApi.SystemReboot();\n\t\t\t$('.ui.message.ajax').remove();\n\t\t\tbackupIndex.$ajaxMessagesDiv.after(`<div class=\"ui success message ajax\">${globalTranslate.bkp_SettingsRestoredWaitReboot}</div>`);\n\t\t}\n\t},\n\t/**\n\t * Обработка ответа BackupGetFilesList\n\t * @param response\n\t */\n\tcbBackupGetFilesListAfterResponse(response) {\n\t\tbackupIndex.$dummy.show();\n\t\tif (response.length === 0 || response === false) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tPbxApi.BackupGetFilesList(backupIndex.cbBackupGetFilesListAfterResponse);\n\t\t\t}, 3000);\n\t\t\treturn;\n\t\t}\n\t\tbackupIndex.$dummy.hide();\n\t\t$.each(response, (key, value) => {\n\t\t\tlet $newRow = $(`tr#${value.id}`);\n\t\t\tif ($newRow.length > 0) {\n\t\t\t\t$newRow.remove();\n\t\t\t}\n\t\t\t$newRow = backupIndex.$templateRow.clone();\n\t\t\t$newRow.attr('id', value.id);\n\t\t\t$newRow.addClass('backupIndex-file');\n\t\t\tconst arhDate = new Date(1000 * value.date);\n\t\t\t$newRow.find('.create-date').html(arhDate.toLocaleString());\n\t\t\t$newRow.find('.file-size').html(`${value.size} MB`);\n\t\t\tif (value.pid.length + value.pid_recover.length > 0) {\n\t\t\t\t$newRow.find('a').each((index, obj) => {\n\t\t\t\t\t$(obj).remove();\n\t\t\t\t});\n\t\t\t\tconst percentOfTotal = 100 * (value.progress / value.total);\n\t\t\t\t$newRow.find('.status').html(`<i class=\"spinner loading icon\"></i> ${parseInt(percentOfTotal, 10)} %`);\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tPbxApi.BackupGetFilesList(backupIndex.cbBackupGetFilesListAfterResponse);\n\t\t\t\t}, 3000);\n\t\t\t} else {\n\t\t\t\t$newRow.find('a').each((index, obj) => {\n\t\t\t\t\t$(obj).attr('href', $(obj).attr('href') + value.id);\n\t\t\t\t\t$(obj).attr('data-value', value.id);\n\t\t\t\t});\n\t\t\t\t$newRow.find('.status').html('<i class=\"archive icon\"></i>');\n\t\t\t}\n\t\t\t$newRow.appendTo('#existing-backup-files-table');\n\t\t});\n\t},\n};\n\n$(document).ready(() => {\n\tbackupIndex.initialize();\n});\n"],"file":"backup-index.js"}