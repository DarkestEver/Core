{"version":3,"sources":["../../src/Backup/backup-index.js"],"names":["mergingCheckWorker","timeOut","timeOutHandle","errorCounts","$progressBarLabel","$","find","fileID","isXML","initialize","restartWorker","window","clearTimeout","timeoutHandle","worker","PbxApi","BackupStatusUpload","cbAfterResponse","setTimeout","response","text","globalTranslate","bkp_UploadError","UserMessage","showError","undefined","Object","keys","length","status_upload","bkp_UploadComplete","bkp_SettingsRestoredWaitReboot","SystemReboot","location","reload","bkp_UploadProcessingFiles","backupIndex","$templateRow","$dummy","$uploadButton","$progressBar","$body","resumable","hide","BackupGetFilesList","cbBackupGetFilesListAfterResponse","on","e","preventDefault","id","target","closest","attr","BackupDownloadFile","BackupDeleteFile","cbAfterDeleteFile","initializeResumable","globalRootUrl","show","each","key","value","$newRow","remove","clone","addClass","arhDate","Date","date","html","toLocaleString","size","pid","pid_recover","index","obj","percentOfTotal","progress","total","parseInt","appendTo","r","Resumable","backupUpload","testChunks","chunkSize","maxFiles","fileType","assignBrowse","document","getElementById","file","console","debug","type","checkStatusFileMerging","removeClass","event","upload","message","ConfigWorker","stopConfigWorker","bkp_UploadInProgress","percent","tryParseJSON","json","JSON","parse","data","backup_id","ready"],"mappings":"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","sourcesContent":["/*\n * Copyright (C) MIKO LLC - All Rights Reserved\n * Unauthorized copying of this file, via any medium is strictly prohibited\n * Proprietary and confidential\n * Written by Nikolay Beketov, 6 2018\n *\n */\n\n/* global PbxApi, globalTranslate, ConfigWorker, Resumable, globalRootUrl, UserMessage */\n\nconst mergingCheckWorker = {\n\ttimeOut: 3000,\n\ttimeOutHandle: '',\n\terrorCounts: 0,\n\t$progressBarLabel: $('#upload-progress-bar').find('.label'),\n\tfileID: null,\n\tisXML: false,\n\tinitialize(fileID, isXML = false) {\n\t\t// Запустим обновление статуса провайдера\n\t\tmergingCheckWorker.fileID = fileID;\n\t\tmergingCheckWorker.isXML = isXML;\n\t\tmergingCheckWorker.restartWorker(fileID);\n\t},\n\trestartWorker() {\n\t\twindow.clearTimeout(mergingCheckWorker.timeoutHandle);\n\t\tmergingCheckWorker.worker();\n\t},\n\tworker() {\n\t\tPbxApi.BackupStatusUpload(mergingCheckWorker.fileID, mergingCheckWorker.cbAfterResponse);\n\t\tmergingCheckWorker.timeoutHandle = window.setTimeout(\n\t\t\tmergingCheckWorker.worker,\n\t\t\tmergingCheckWorker.timeOut,\n\t\t);\n\t},\n\tcbAfterResponse(response) {\n\t\tif (mergingCheckWorker.errorCounts > 10) {\n\t\t\tmergingCheckWorker.$progressBarLabel.text(globalTranslate.bkp_UploadError);\n\t\t\tUserMessage.showError(globalTranslate.bkp_UploadError);\n\t\t\twindow.clearTimeout(mergingCheckWorker.timeoutHandle);\n\t\t}\n\t\tif (response === undefined || Object.keys(response).length === 0) {\n\t\t\tmergingCheckWorker.errorCounts += 1;\n\t\t\treturn;\n\t\t}\n\t\tif (response.status_upload === 'COMPLETE') {\n\t\t\tmergingCheckWorker.$progressBarLabel.text(globalTranslate.bkp_UploadComplete);\n\t\t\tif (mergingCheckWorker.isXML) {\n\t\t\t\tmergingCheckWorker.$progressBarLabel.text(globalTranslate.bkp_SettingsRestoredWaitReboot);\n\t\t\t\tPbxApi.SystemReboot();\n\t\t\t} else {\n\t\t\t\twindow.location.reload();\n\t\t\t}\n\t\t} else if (response.status_upload !== undefined) {\n\t\t\tmergingCheckWorker.$progressBarLabel.text(globalTranslate.bkp_UploadProcessingFiles);\n\t\t\tmergingCheckWorker.errorCounts = 0;\n\t\t} else {\n\t\t\tmergingCheckWorker.errorCounts += 1;\n\t\t}\n\t},\n\n};\n\n\nconst backupIndex = {\n\t$templateRow: $('#backup-template-row'),\n\t$dummy: $('#dummy-row'),\n\t$uploadButton: $('#uploadbtn'),\n\t$progressBar: $('#upload-progress-bar'),\n\t$progressBarLabel: $('#upload-progress-bar').find('.label'),\n\t$body: $('body'),\n\tresumable: null,\n\tinitialize() {\n\t\tbackupIndex.$progressBar.hide();\n\t\tPbxApi.BackupGetFilesList(backupIndex.cbBackupGetFilesListAfterResponse);\n\t\tbackupIndex.$body.on('click', 'a.download', (e) => {\n\t\t\te.preventDefault();\n\t\t\tconst id = $(e.target).closest('a').attr('data-value');\n\t\t\tPbxApi.BackupDownloadFile(id);\n\t\t});\n\t\tbackupIndex.$body.on('click', 'a.delete', (e) => {\n\t\t\te.preventDefault();\n\t\t\tconst id = $(e.target).closest('a').attr('data-value');\n\t\t\tPbxApi.BackupDeleteFile(id, backupIndex.cbAfterDeleteFile);\n\t\t});\n\t\tbackupIndex.initializeResumable();\n\t},\n\n\t/**\n\t * Коллбек после удаления файла бекапа\n\t * @param response\n\t */\n\tcbAfterDeleteFile(response) {\n\t\tif (response) {\n\t\t\twindow.location = `${globalRootUrl}backup/index`;\n\t\t}\n\t},\n\t/**\n\t * Обработка ответа BackupGetFilesList\n\t * @param response\n\t */\n\tcbBackupGetFilesListAfterResponse(response) {\n\t\tbackupIndex.$dummy.show();\n\t\tif (response.length === 0 || response === false) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tPbxApi.BackupGetFilesList(backupIndex.cbBackupGetFilesListAfterResponse);\n\t\t\t}, 3000);\n\t\t\treturn;\n\t\t}\n\t\tbackupIndex.$dummy.hide();\n\t\t$.each(response, (key, value) => {\n\t\t\tlet $newRow = $(`tr#${value.id}`);\n\t\t\tif ($newRow.length > 0) {\n\t\t\t\t$newRow.remove();\n\t\t\t}\n\t\t\t$newRow = backupIndex.$templateRow.clone();\n\t\t\t$newRow.attr('id', value.id);\n\t\t\t$newRow.addClass('backupIndex-file');\n\t\t\tconst arhDate = new Date(1000 * value.date);\n\t\t\t$newRow.find('.create-date').html(arhDate.toLocaleString());\n\t\t\t$newRow.find('.file-size').html(`${value.size} MB`);\n\t\t\tif (value.pid.length + value.pid_recover.length > 0) {\n\t\t\t\t$newRow.find('a').each((index, obj) => {\n\t\t\t\t\t$(obj).remove();\n\t\t\t\t});\n\t\t\t\tconst percentOfTotal = 100 * (value.progress / value.total);\n\t\t\t\t$newRow.find('.status').html(`<i class=\"spinner loading icon\"></i> ${parseInt(percentOfTotal, 10)} %`);\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tPbxApi.BackupGetFilesList(backupIndex.cbBackupGetFilesListAfterResponse);\n\t\t\t\t}, 3000);\n\t\t\t} else {\n\t\t\t\t$newRow.find('a').each((index, obj) => {\n\t\t\t\t\t$(obj).attr('href', $(obj).attr('href') + value.id);\n\t\t\t\t\t$(obj).attr('data-value', value.id);\n\t\t\t\t});\n\t\t\t\t$newRow.find('.status').html('<i class=\"archive icon\"></i>');\n\t\t\t}\n\t\t\t$newRow.appendTo('#existing-backup-files-table');\n\t\t});\n\t},\n\t/**\n\t * Подключение обработчкика загрузки файлов по частям\n\t */\n\tinitializeResumable() {\n\t\tconst r = new Resumable({\n\t\t\ttarget: PbxApi.backupUpload,\n\t\t\ttestChunks: false,\n\t\t\tchunkSize: 30 * 1024 * 1024,\n\t\t\tmaxFiles: 1,\n\t\t\tfileType: ['img', 'zip', 'xml'],\n\t\t});\n\n\t\tr.assignBrowse(document.getElementById('uploadbtn'));\n\t\tr.on('fileSuccess', (file, response) => {\n\t\t\tconsole.debug('fileSuccess', file);\n\t\t\tlet isXML = false;\n\t\t\tif (file.file !== undefined && file.file.type !== undefined) {\n\t\t\t\tisXML = file.file.type === 'text/xml';\n\t\t\t}\n\t\t\tbackupIndex.checkStatusFileMerging(response, isXML);\n\t\t\tbackupIndex.$uploadButton.removeClass('loading');\n\t\t});\n\t\tr.on('fileProgress', (file) => {\n\t\t\tconsole.debug('fileProgress', file);\n\t\t});\n\t\tr.on('fileAdded', (file, event) => {\n\t\t\tr.upload();\n\t\t\tconsole.debug('fileAdded', event);\n\t\t});\n\t\tr.on('fileRetry', (file) => {\n\t\t\tconsole.debug('fileRetry', file);\n\t\t});\n\t\tr.on('fileError', (file, message) => {\n\t\t\tconsole.debug('fileError', file, message);\n\t\t});\n\n\t\tr.on('uploadStart', () => {\n\t\t\tconsole.debug('uploadStart');\n\t\t\tConfigWorker.stopConfigWorker();\n\t\t\tbackupIndex.$uploadButton.addClass('loading');\n\t\t\tbackupIndex.$progressBar.show();\n\t\t\tbackupIndex.$progressBarLabel.text(globalTranslate.bkp_UploadInProgress);\n\t\t});\n\t\tr.on('complete', () => {\n\t\t\tconsole.debug('complete');\n\t\t});\n\t\tr.on('progress', () => {\n\t\t\tconsole.debug('progress');\n\t\t\tbackupIndex.$progressBar.progress({\n\t\t\t\tpercent: 100 * r.progress(),\n\t\t\t});\n\t\t});\n\t\tr.on('error', (message, file) => {\n\t\t\tconsole.debug('error', message, file);\n\t\t\tbackupIndex.$progressBarLabel.text(globalTranslate.bkp_UploadError);\n\t\t\tbackupIndex.$uploadButton.removeClass('loading');\n\t\t\tUserMessage.showError(`${globalTranslate.bkp_UploadError}<br>${message}`);\n\t\t});\n\t\tr.on('pause', () => {\n\t\t\tconsole.debug('pause');\n\t\t});\n\t\tr.on('cancel', () => {\n\t\t\tconsole.debug('cancel');\n\t\t});\n\t},\n\t/**\n\t * Запуск процесса ожидания склеивания файла после загрузки на сервер\n\t *\n\t * @param response ответ функции /pbxcore/api/backup/upload\n\t */\n\tcheckStatusFileMerging(response, isXML) {\n\t\tif (response === undefined || PbxApi.tryParseJSON(response) === false) {\n\t\t\tUserMessage.showError(`${globalTranslate.bkp_UploadError}`);\n\t\t\treturn;\n\t\t}\n\t\tconst json = JSON.parse(response);\n\t\tif (json === undefined || json.data === undefined) {\n\t\t\tUserMessage.showError(`${globalTranslate.bkp_UploadError}`);\n\t\t\treturn;\n\t\t}\n\t\tconst fileID = json.data.backup_id;\n\t\tmergingCheckWorker.initialize(fileID, isXML);\n\t},\n\n};\n\n\n$(document).ready(() => {\n\tbackupIndex.initialize();\n});\n"],"file":"backup-index.js"}