{"version":3,"sources":["../../src/Licensing/license-check-worker.js"],"names":["licenseCheckWorker","timeOut","timeOutHandle","$licenseWarningMessage","$","initialize","restartWorker","window","clearTimeout","timeoutHandle","worker","previousLicenseCheckResult","localStorage","getItem","nowTime","Math","floor","Date","now","oldCheckTime","JSON","parse","time","oldCheckResult","result","hide","show","api","url","globalRootUrl","on","onSuccess","response","cbAfterResponse","onError","errorMessage","element","xhr","status","location","PbxApi","CheckLicense","NeedAjax","setTimeout","setItem","document","ready"],"mappings":"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","sourcesContent":["/*\n * Copyright (C) MIKO LLC - All Rights Reserved\n * Unauthorized copying of this file, via any medium is strictly prohibited\n * Proprietary and confidential\n * Written by Nikolay Beketov, 11 2018\n *\n */\n\n/* global PbxApi, globalRootUrl  */\n/**\n * Периодическая проверка на наличие лицензионного ключа,\n * для отображения информации о ошибке в заголовке всех форм\n */\nconst licenseCheckWorker = {\n\ttimeOut: 300000,\n\ttimeOutHandle: '',\n\t$licenseWarningMessage: $('#license-warning'),\n\tinitialize() {\n\t\t// Запустим обновление статуса провайдера\n\t\tlicenseCheckWorker.restartWorker();\n\t},\n\trestartWorker() {\n\t\twindow.clearTimeout(licenseCheckWorker.timeoutHandle);\n\t\tlicenseCheckWorker.worker();\n\t},\n\tworker() {\n\t\tconst previousLicenseCheckResult = localStorage.getItem('previousLicenseCheckResult');\n\t\tconst nowTime = Math.floor(Date.now() / 1000);\n\t\tif (previousLicenseCheckResult !== null) {\n\t\t\tconst oldCheckTime = JSON.parse(previousLicenseCheckResult).time;\n\t\t\tconst oldCheckResult = JSON.parse(previousLicenseCheckResult).result;\n\t\t\tif (nowTime - oldCheckTime < licenseCheckWorker.timeOut) {\n\t\t\t\tif (oldCheckResult === true) {\n\t\t\t\t\tlicenseCheckWorker.$licenseWarningMessage.hide();\n\t\t\t\t} else {\n\t\t\t\t\tlicenseCheckWorker.$licenseWarningMessage.show();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$.api({\n\t\t\t\t\turl: `${globalRootUrl}/advices/getAdvices/`,\n\t\t\t\t\ton: 'now',\n\t\t\t\t\tonSuccess(response) {\n\t\t\t\t\t\tlicenseCheckWorker.cbAfterResponse(response);\n\t\t\t\t\t},\n\t\t\t\t\tonError(errorMessage, element, xhr) {\n\t\t\t\t\t\tif (xhr.status === 403) {\n\t\t\t\t\t\t\twindow.location = `${globalRootUrl}session/index`;\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tPbxApi.CheckLicense(licenseCheckWorker.cbAfterResponse);\n\t\t}\n\t\tif (NeedAjax){\n\t\t\t\n\t\t}\n\t\tlicenseCheckWorker.timeoutHandle = window.setTimeout(\n\t\t\tlicenseCheckWorker.worker,\n\t\t\tlicenseCheckWorker.timeOut,\n\t\t);\n\t},\n\tcbAfterResponse(result) {\n\t\tif (result === true) {\n\t\t\tlicenseCheckWorker.$licenseWarningMessage.hide();\n\t\t} else {\n\t\t\tlicenseCheckWorker.$licenseWarningMessage.show();\n\t\t}\n\t\tconst nowTime = Math.floor(Date.now() / 1000);\n\n\t\tlocalStorage.setItem('previousLicenseCheckResult', `{\"time\":${nowTime}, \"result\":${result === true} }`);\n\t},\n\n};\n\n$(document).ready(() => {\n\tlicenseCheckWorker.initialize();\n});\n"],"file":"license-check-worker.js"}