{"version":3,"sources":["../../src/main/pbx-config-worker.js"],"names":["ConfigWorker","timeOut","timeOutHandle","uiResetConfigurationChangesUrl","globalRootUrl","uiCheckConfigurationChangesUrl","$applyConfigurationButton","$","$submitButton","stillWorking","initialize","restartWorker","stopConfigWorker","window","clearTimeout","timeoutHandle","worker","setTimeout","api","url","on","onSuccess","response","undefined","changed","localStorage","setItem","actions","applyConfigurationChanges","removeClass","onError","errorMessage","element","xhr","status","location","cbAfterResponse","appliedFunction","needApplyActions","getItem","newActionsArray","JSON","parse","filter","e","stringify","urlData","length","addClass","actionName","PbxApi","document","ready"],"mappings":"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","sourcesContent":["/*\n * Copyright (C) MIKO LLC - All Rights Reserved\n * Unauthorized copying of this file, via any medium is strictly prohibited\n * Proprietary and confidential\n * Written by Nikolay Beketov, 6 2018\n *\n */\n\n/* global globalRootUrl, PbxApi */\n\nconst ConfigWorker = {\n\ttimeOut: 5000,\n\ttimeOutHandle: '',\n\tuiResetConfigurationChangesUrl: `${globalRootUrl}configuration-apply/resetConfigurationChanged/{appliedFunction}`,\n\tuiCheckConfigurationChangesUrl: `${globalRootUrl}configuration-apply/getNewConfigurationChanges`,\n\t$applyConfigurationButton: $('#apply-configuration-button'),\n\t$submitButton: $('#submitbutton'),\n\tstillWorking: false,\n\tinitialize() {\n\t\t// Запустим обновление статуса провайдера\n\t\tConfigWorker.restartWorker();\n\t},\n\tstopConfigWorker() {\n\t\twindow.clearTimeout(ConfigWorker.timeoutHandle);\n\t\tConfigWorker.stillWorking = false;\n\t},\n\trestartWorker() {\n\t\tConfigWorker.stillWorking = false;\n\t\twindow.clearTimeout(ConfigWorker.timeoutHandle);\n\t\tConfigWorker.worker();\n\t},\n\tworker() {\n\t\tif (ConfigWorker.stillWorking) return;\n\t\tConfigWorker.timeoutHandle = window.setTimeout(ConfigWorker.worker, ConfigWorker.timeOut);\n\t\tConfigWorker.stillWorking = true;\n\t\t$.api({\n\t\t\turl: ConfigWorker.uiCheckConfigurationChangesUrl,\n\t\t\ton: 'now',\n\t\t\tonSuccess(response) {\n\t\t\t\tif (response !== undefined && response.changed === true) {\n\t\t\t\t\tlocalStorage.setItem('NeedApplyActions', response.actions);\n\t\t\t\t\t// Прпробуем сразу применять после сохранения\n\t\t\t\t\t// window.clearTimeout(ConfigWorker.timeoutHandle);\n\t\t\t\t\tConfigWorker.applyConfigurationChanges();\n\t\t\t\t} else {\n\t\t\t\t\tConfigWorker.$submitButton.removeClass('loading');\n\t\t\t\t}\n\t\t\t\tConfigWorker.stillWorking = false;\n\t\t\t},\n\t\t\tonError(errorMessage, element, xhr) {\n\t\t\t\tif (xhr.status === 403) {\n\t\t\t\t\twindow.location = `${globalRootUrl}session/index`;\n\t\t\t\t}\n\t\t\t\tConfigWorker.stillWorking = false;\n\t\t\t},\n\t\t});\n\t},\n\tcbAfterResponse(appliedFunction) {\n\t\tconst needApplyActions = localStorage.getItem('NeedApplyActions');\n\t\tconst newActionsArray = JSON.parse(needApplyActions).filter(e => e !== appliedFunction);\n\t\tlocalStorage.setItem('NeedApplyActions', JSON.stringify(newActionsArray));\n\t\t$.api({\n\t\t\turl: ConfigWorker.uiResetConfigurationChangesUrl,\n\t\t\ton: 'now',\n\t\t\turlData: {\n\t\t\t\tappliedFunction,\n\t\t\t},\n\t\t});\n\t\tConfigWorker.applyConfigurationChanges(); // Выполним следующую итерацию проверки изменений\n\t},\n\tapplyConfigurationChanges() {\n\t\tconst needApplyActions = JSON.parse(localStorage.getItem('NeedApplyActions'));\n\t\tif (needApplyActions.length > 0) {\n\t\t\tConfigWorker.$submitButton.addClass('loading');\n\t\t\tconst actionName = needApplyActions[0];\n\t\t\tPbxApi[actionName](ConfigWorker.cbAfterResponse);\n\t\t} else {\n\t\t\tConfigWorker.$submitButton.removeClass('loading');\n\t\t\t// window.clearTimeout(ConfigWorker.timeoutHandle);\n\t\t}\n\t},\n\n};\n\n\n$(document).ready(() => {\n\tConfigWorker.initialize();\n});\n"],"file":"pbx-config-worker.js"}