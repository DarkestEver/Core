"use strict";

/*
 * Copyright (C) MIKO LLC - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Nikolay Beketov, 12 2019
 *
 */

/* global UserMessage, globalTranslate, PbxApi, upgradeStatusLoopWorker */
var addNewExtension = {
  $uploadButton: $('#add-new-button'),
  $progressBar: $('#upload-progress-bar'),
  $progressBarLabel: $('#upload-progress-bar').find('.label'),
  uploadInProgress: false,
  initialize: function () {
    function initialize() {
      addNewExtension.$progressBar.hide();
      addNewExtension.$uploadButton.on('click', function (e) {
        e.preventDefault();

        if (addNewExtension.$uploadButton.hasClass('loading') || addNewExtension.uploadInProgress) {
          return;
        }

        $('input:file', $(e.target).parents()).click();
      });
      $('input:file').on('change', function (e) {
        if (e.target.files[0] !== undefined) {
          var filename = e.target.files[0].name;
          $('input:text', $(e.target).parent()).val(filename);
          var data = $('input:file')[0].files[0];
          PbxApi.SystemUploadFile(data, addNewExtension.cbResumableUploadFile);
        }
      });
    }

    return initialize;
  }(),

  /**
   * Upload file by chunks
   * @param action
   * @param params
   */
  cbResumableUploadFile: function () {
    function cbResumableUploadFile(action, params) {
      switch (action) {
        case 'fileSuccess':
          addNewExtension.checkStatusFileMerging(params.response);
          break;

        case 'uploadStart':
          addNewExtension.uploadInProgress = true;
          addNewExtension.$uploadButton.addClass('loading');
          addNewExtension.$progressBar.show();
          addNewExtension.$progressBarLabel.text(globalTranslate.ext_UploadInProgress);
          break;

        case 'progress':
          addNewExtension.$progressBar.progress({
            percent: parseInt(params.percent, 10)
          });
          break;

        case 'error':
          addNewExtension.$progressBarLabel.text(globalTranslate.ext_UploadError);
          addNewExtension.$uploadButton.removeClass('loading');
          UserMessage.showError(globalTranslate.ext_UploadError);
          break;

        default:
      }
    }

    return cbResumableUploadFile;
  }(),

  /**
   * Wait for file ready to use
   *
   * @param response ответ функции /pbxcore/api/upload/status
   */
  checkStatusFileMerging: function () {
    function checkStatusFileMerging(response) {
      if (response === undefined || PbxApi.tryParseJSON(response) === false) {
        UserMessage.showError("".concat(globalTranslate.ext_UploadError));
        return;
      }

      var json = JSON.parse(response);

      if (json === undefined || json.data === undefined) {
        UserMessage.showError("".concat(globalTranslate.ext_UploadError));
        return;
      }

      var fileID = json.data.upload_id;
      var filePath = json.data.filename;
      mergingCheckWorker.initialize(fileID, filePath);
    }

    return checkStatusFileMerging;
  }(),
  cbAfterUploadFile: function () {
    function cbAfterUploadFile(response, success) {
      if (response.length === 0 || response === false || success === false) {
        addNewExtension.$uploadButton.removeClass('loading');
        addNewExtension.uploadInProgress = false;
        UserMessage.showError(globalTranslate.ext_UploadError);
      } else if (response["function"] === 'upload_progress' && success) {
        addNewExtension.$progressBar.progress({
          percent: parseInt(response.percent, 10)
        });

        if (response.percent < 100) {
          addNewExtension.$progressBarLabel.text(globalTranslate.ext_UploadInProgress);
        } else {
          addNewExtension.$progressBarLabel.text(globalTranslate.ext_InstallationInProgress);
        }
      } else if (response["function"] === 'uploadNewModule' && success) {
        upgradeStatusLoopWorker.initialize(response.uniqid, false);
      } else {
        UserMessage.showMultiString(response.message);
      }
    }

    return cbAfterUploadFile;
  }()
};
var mergingCheckWorker = {
  timeOut: 3000,
  timeOutHandle: '',
  errorCounts: 0,
  $progressBarLabel: $('#upload-progress-bar').find('.label'),
  fileID: null,
  filePath: '',
  initialize: function () {
    function initialize(fileID, filePath) {
      // Запустим обновление статуса провайдера
      mergingCheckWorker.fileID = fileID;
      mergingCheckWorker.filePath = filePath;
      mergingCheckWorker.restartWorker(fileID);
    }

    return initialize;
  }(),
  restartWorker: function () {
    function restartWorker() {
      window.clearTimeout(mergingCheckWorker.timeoutHandle);
      mergingCheckWorker.worker();
    }

    return restartWorker;
  }(),
  worker: function () {
    function worker() {
      PbxApi.SystemGetStatusUploadFile(mergingCheckWorker.fileID, mergingCheckWorker.cbAfterResponse);
      mergingCheckWorker.timeoutHandle = window.setTimeout(mergingCheckWorker.worker, mergingCheckWorker.timeOut);
    }

    return worker;
  }(),
  cbAfterResponse: function () {
    function cbAfterResponse(response) {
      if (mergingCheckWorker.errorCounts > 10) {
        mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_UploadError);
        UserMessage.showError(globalTranslate.ext_UploadError);
        addNewExtension.$uploadButton.removeClass('loading');
        window.clearTimeout(mergingCheckWorker.timeoutHandle);
      }

      if (response === undefined || Object.keys(response).length === 0) {
        mergingCheckWorker.errorCounts += 1;
        return;
      }

      if (response.d_status === 'UPLOAD_COMPLETE') {
        mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_InstallationInProgress);
        PbxApi.SystemInstallModule(mergingCheckWorker.filePath, mergingCheckWorker.cbAfterModuleInstall);
        window.clearTimeout(mergingCheckWorker.timeoutHandle);
      } else if (response.d_status !== undefined) {
        mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_UploadInProgress);
        mergingCheckWorker.errorCounts = 0;
      } else {
        mergingCheckWorker.errorCounts += 1;
      }
    }

    return cbAfterResponse;
  }(),
  cbAfterModuleInstall: function () {
    function cbAfterModuleInstall(response) {
      if (response === true) {
        window.location.reload();
      } else {
        UserMessage.showError(globalTranslate.ext_InstallationError);
      }
    }

    return cbAfterModuleInstall;
  }()
};
$(document).ready(function () {
  addNewExtension.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWFkZC1uZXcuanMiXSwibmFtZXMiOlsiYWRkTmV3RXh0ZW5zaW9uIiwiJHVwbG9hZEJ1dHRvbiIsIiQiLCIkcHJvZ3Jlc3NCYXIiLCIkcHJvZ3Jlc3NCYXJMYWJlbCIsImZpbmQiLCJ1cGxvYWRJblByb2dyZXNzIiwiaW5pdGlhbGl6ZSIsImhpZGUiLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImhhc0NsYXNzIiwidGFyZ2V0IiwicGFyZW50cyIsImNsaWNrIiwiZmlsZXMiLCJ1bmRlZmluZWQiLCJmaWxlbmFtZSIsIm5hbWUiLCJwYXJlbnQiLCJ2YWwiLCJkYXRhIiwiUGJ4QXBpIiwiU3lzdGVtVXBsb2FkRmlsZSIsImNiUmVzdW1hYmxlVXBsb2FkRmlsZSIsImFjdGlvbiIsInBhcmFtcyIsImNoZWNrU3RhdHVzRmlsZU1lcmdpbmciLCJyZXNwb25zZSIsImFkZENsYXNzIiwic2hvdyIsInRleHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfVXBsb2FkSW5Qcm9ncmVzcyIsInByb2dyZXNzIiwicGVyY2VudCIsInBhcnNlSW50IiwiZXh0X1VwbG9hZEVycm9yIiwicmVtb3ZlQ2xhc3MiLCJVc2VyTWVzc2FnZSIsInNob3dFcnJvciIsInRyeVBhcnNlSlNPTiIsImpzb24iLCJKU09OIiwicGFyc2UiLCJmaWxlSUQiLCJ1cGxvYWRfaWQiLCJmaWxlUGF0aCIsIm1lcmdpbmdDaGVja1dvcmtlciIsImNiQWZ0ZXJVcGxvYWRGaWxlIiwic3VjY2VzcyIsImxlbmd0aCIsImV4dF9JbnN0YWxsYXRpb25JblByb2dyZXNzIiwidXBncmFkZVN0YXR1c0xvb3BXb3JrZXIiLCJ1bmlxaWQiLCJzaG93TXVsdGlTdHJpbmciLCJtZXNzYWdlIiwidGltZU91dCIsInRpbWVPdXRIYW5kbGUiLCJlcnJvckNvdW50cyIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwiU3lzdGVtR2V0U3RhdHVzVXBsb2FkRmlsZSIsImNiQWZ0ZXJSZXNwb25zZSIsInNldFRpbWVvdXQiLCJPYmplY3QiLCJrZXlzIiwiZF9zdGF0dXMiLCJTeXN0ZW1JbnN0YWxsTW9kdWxlIiwiY2JBZnRlck1vZHVsZUluc3RhbGwiLCJsb2NhdGlvbiIsInJlbG9hZCIsImV4dF9JbnN0YWxsYXRpb25FcnJvciIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7O0FBUUE7QUFFQSxJQUFNQSxlQUFlLEdBQUc7QUFDdkJDLEVBQUFBLGFBQWEsRUFBRUMsQ0FBQyxDQUFDLGlCQUFELENBRE87QUFFdkJDLEVBQUFBLFlBQVksRUFBRUQsQ0FBQyxDQUFDLHNCQUFELENBRlE7QUFHdkJFLEVBQUFBLGlCQUFpQixFQUFFRixDQUFDLENBQUMsc0JBQUQsQ0FBRCxDQUEwQkcsSUFBMUIsQ0FBK0IsUUFBL0IsQ0FISTtBQUl2QkMsRUFBQUEsZ0JBQWdCLEVBQUUsS0FKSztBQUt2QkMsRUFBQUEsVUFMdUI7QUFBQSwwQkFLVjtBQUNaUCxNQUFBQSxlQUFlLENBQUNHLFlBQWhCLENBQTZCSyxJQUE3QjtBQUNBUixNQUFBQSxlQUFlLENBQUNDLGFBQWhCLENBQThCUSxFQUE5QixDQUFpQyxPQUFqQyxFQUEwQyxVQUFDQyxDQUFELEVBQU87QUFDaERBLFFBQUFBLENBQUMsQ0FBQ0MsY0FBRjs7QUFDQSxZQUNDWCxlQUFlLENBQUNDLGFBQWhCLENBQThCVyxRQUE5QixDQUF1QyxTQUF2QyxLQUNHWixlQUFlLENBQUNNLGdCQUZwQixFQUdFO0FBQUU7QUFBUzs7QUFDYkosUUFBQUEsQ0FBQyxDQUFDLFlBQUQsRUFBZUEsQ0FBQyxDQUFDUSxDQUFDLENBQUNHLE1BQUgsQ0FBRCxDQUFZQyxPQUFaLEVBQWYsQ0FBRCxDQUF1Q0MsS0FBdkM7QUFDQSxPQVBEO0FBU0FiLE1BQUFBLENBQUMsQ0FBQyxZQUFELENBQUQsQ0FBZ0JPLEVBQWhCLENB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LFFBQUFBLGtCQUFrQixDQUFDVyxXQUFuQixHQUFpQyxDQUFqQztBQUNBLE9BSE0sTUFHQTtBQUNOWCxRQUFBQSxrQkFBa0IsQ0FBQ1csV0FBbkIsSUFBa0MsQ0FBbEM7QUFDQTtBQUNEOztBQTdDeUI7QUFBQTtBQThDMUJhLEVBQUFBLG9CQTlDMEI7QUFBQSxrQ0E4Q0w1QyxRQTlDSyxFQThDSTtBQUM3QixVQUFJQSxRQUFRLEtBQUcsSUFBZixFQUFvQjtBQUNuQmlDLFFBQUFBLE1BQU0sQ0FBQ1ksUUFBUCxDQUFnQkMsTUFBaEI7QUFDQSxPQUZELE1BRU87QUFDTm5DLFFBQUFBLFdBQVcsQ0FBQ0MsU0FBWixDQUFzQlIsZUFBZSxDQUFDMkMscUJBQXRDO0FBQ0E7QUFDRDs7QUFwRHlCO0FBQUE7QUFBQSxDQUEzQjtBQXVEQTFFLENBQUMsQ0FBQzJFLFFBQUQsQ0FBRCxDQUFZQyxLQUFaLENBQWtCLFlBQU07QUFDdkI5RSxFQUFBQSxlQUFlLENBQUNPLFVBQWhCO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKEMpIE1JS08gTExDIC0gQWxsIFJpZ2h0cyBSZXNlcnZlZFxuICogVW5hdXRob3JpemVkIGNvcHlpbmcgb2YgdGhpcyBmaWxlLCB2aWEgYW55IG1lZGl1bSBpcyBzdHJpY3RseSBwcm9oaWJpdGVkXG4gKiBQcm9wcmlldGFyeSBhbmQgY29uZmlkZW50aWFsXG4gKiBXcml0dGVuIGJ5IE5pa29sYXkgQmVrZXRvdiwgMTIgMjAxOVxuICpcbiAqL1xuXG4vKiBnbG9iYWwgVXNlck1lc3NhZ2UsIGdsb2JhbFRyYW5zbGF0ZSwgUGJ4QXBpLCB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlciAqLyBcblxuY29uc3QgYWRkTmV3RXh0ZW5zaW9uID0ge1xuXHQkdXBsb2FkQnV0dG9uOiAkKCcjYWRkLW5ldy1idXR0b24nKSxcblx0JHByb2dyZXNzQmFyOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhcicpLFxuXHQkcHJvZ3Jlc3NCYXJMYWJlbDogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKS5maW5kKCcubGFiZWwnKSxcblx0dXBsb2FkSW5Qcm9ncmVzczogZmFsc2UsXG5cdGluaXRpYWxpemUoKSB7XG5cdFx0YWRkTmV3RXh0ZW5zaW9uLiRwcm9ncmVzc0Jhci5oaWRlKCk7XG5cdFx0YWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24ub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdGlmIChcblx0XHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24uaGFzQ2xhc3MoJ2xvYWRpbmcnKVxuXHRcdFx0XHR8fCBhZGROZXdFeHRlbnNpb24udXBsb2FkSW5Qcm9ncmVzc1xuXHRcdFx0KSB7IHJldHVybjsgfVxuXHRcdFx0JCgnaW5wdXQ6ZmlsZScsICQoZS50YXJnZXQpLnBhcmVudHMoKSkuY2xpY2soKTtcblx0XHR9KTtcblxuXHRcdCQoJ2lucHV0OmZpbGUnKS5vbignY2hhbmdlJywgKGUpID0+IHtcblx0XHRcdGlmIChlLnRhcmdldC5maWxlc1swXSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdGNvbnN0IGZpbGVuYW1lID0gZS50YXJnZXQuZmlsZXNbMF0ubmFtZTtcblx0XHRcdFx0JCgnaW5wdXQ6dGV4dCcsICQoZS50YXJnZXQpLnBhcmVudCgpKS52YWwoZmlsZW5hbWUpO1xuXHRcdFx0XHRjb25zdCBkYXRhID0gJCgnaW5wdXQ6ZmlsZScpWzBdLmZpbGVzWzBdO1xuXHRcdFx0XHRQYnhBcGkuU3lzdGVtVXBsb2FkRmlsZShkYXRhLCBhZGROZXdFeHRlbnNpb24uY2JSZXN1bWFibGVVcGxvYWRGaWxlKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fSxcblx0LyoqXG5cdCAqIFVwbG9hZCBmaWxlIGJ5IGNodW5rc1xuXHQgKiBAcGFyYW0gYWN0aW9uXG5cdCAqIEBwYXJhbSBwYXJhbXNcblx0ICovXG5cdGNiUmVzdW1hYmxlVXBsb2FkRmlsZShhY3Rpb24sIHBhcmFtcyl7XG5cdFx0c3dpdGNoIChhY3Rpb24pIHtcblx0XHRcdGNhc2UgJ2ZpbGVTdWNjZXNzJzpcblx0XHRcdFx0YWRkTmV3RXh0ZW5zaW9uLmNoZWNrU3RhdHVzRmlsZU1lcmdpbmcocGFyYW1zLnJlc3BvbnNlKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICd1cGxvYWRTdGFydCc6XG5cdFx0XHRcdGFkZE5ld0V4dGVuc2lvbi51cGxvYWRJblByb2dyZXNzID0gdHJ1ZTtcblx0XHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24uYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiRwcm9ncmVzc0Jhci5zaG93KCk7XG5cdFx0XHRcdGFkZE5ld0V4dGVuc2lvbi4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkSW5Qcm9ncmVzcyk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSAncHJvZ3Jlc3MnOlxuXHRcdFx0XHRhZGROZXdFeHRlbnNpb24uJHByb2dyZXNzQmFyLnByb2dyZXNzKHtcblx0XHRcdFx0XHRwZXJjZW50OiBwYXJzZUludChwYXJhbXMucGVyY2VudCwgMTApLFxuXHRcdFx0XHR9KTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICdlcnJvcic6XG5cdFx0XHRcdGFkZE5ld0V4dGVuc2lvbi4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3IpO1xuXHRcdFx0XHRhZGROZXdFeHRlbnNpb24uJHVwbG9hZEJ1dHRvbi5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuXHRcdFx0XHRVc2VyTWVzc2FnZS5zaG93RXJyb3IoZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRFcnJvcik7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHR9XG5cdH0sXG5cdC8qKlxuXHQgKiBXYWl0IGZvciBmaWxlIHJlYWR5IHRvIHVzZVxuXHQgKlxuXHQgKiBAcGFyYW0gcmVzcG9uc2Ug0L7RgtCy0LXRgiDRhNGD0L3QutGG0LjQuCAvcGJ4Y29yZS9hcGkvdXBsb2FkL3N0YXR1c1xuXHQgKi9cblx0Y2hlY2tTdGF0dXNGaWxlTWVyZ2luZyhyZXNwb25zZSkge1xuXHRcdGlmIChyZXNwb25zZSA9PT0gdW5kZWZpbmVkIHx8IFBieEFwaS50cnlQYXJzZUpTT04ocmVzcG9uc2UpID09PSBmYWxzZSkge1xuXHRcdFx0VXNlck1lc3NhZ2Uuc2hvd0Vycm9yKGAke2dsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3J9YCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKHJlc3BvbnNlKTtcblx0XHRpZiAoanNvbiA9PT0gdW5kZWZpbmVkIHx8IGpzb24uZGF0YSA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRVc2VyTWVzc2FnZS5zaG93RXJyb3IoYCR7Z2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRFcnJvcn1gKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0Y29uc3QgZmlsZUlEID0ganNvbi5kYXRhLnVwbG9hZF9pZDtcblx0XHRjb25zdCBmaWxlUGF0aCA9IGpzb24uZGF0YS5maWxlbmFtZTtcblx0XHRtZXJnaW5nQ2hlY2tXb3JrZXIuaW5pdGlhbGl6ZShmaWxlSUQsIGZpbGVQYXRoKTtcblx0fSxcblx0Y2JBZnRlclVwbG9hZEZpbGUocmVzcG9uc2UsIHN1Y2Nlc3MpIHtcblx0XHRpZiAocmVzcG9uc2UubGVuZ3RoID09PSAwIHx8IHJlc3BvbnNlID09PSBmYWxzZSB8fCBzdWNjZXNzID09PSBmYWxzZSkge1xuXHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdGFkZE5ld0V4dGVuc2lvbi51cGxvYWRJblByb2dyZXNzID0gZmFsc2U7XG5cdFx0XHRVc2VyTWVzc2FnZS5zaG93RXJyb3IoZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRFcnJvcik7XG5cdFx0fSBlbHNlIGlmIChyZXNwb25zZS5mdW5jdGlvbiA9PT0gJ3VwbG9hZF9wcm9ncmVzcycgJiYgc3VjY2Vzcykge1xuXHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiRwcm9ncmVzc0Jhci5wcm9ncmVzcyh7XG5cdFx0XHRcdHBlcmNlbnQ6IHBhcnNlSW50KHJlc3BvbnNlLnBlcmNlbnQsIDEwKSxcblx0XHRcdH0pO1xuXHRcdFx0aWYgKHJlc3BvbnNlLnBlcmNlbnQgPCAxMDApIHtcblx0XHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRJblByb2dyZXNzKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGFkZE5ld0V4dGVuc2lvbi4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uSW5Qcm9ncmVzcyk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmIChyZXNwb25zZS5mdW5jdGlvbiA9PT0gJ3VwbG9hZE5ld01vZHVsZScgJiYgc3VjY2Vzcykge1xuXHRcdFx0dXBncmFkZVN0YXR1c0xvb3BXb3JrZXIuaW5pdGlhbGl6ZShyZXNwb25zZS51bmlxaWQsIGZhbHNlKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0VXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKHJlc3BvbnNlLm1lc3NhZ2UpO1xuXHRcdH1cblx0fSxcbn07XG5cbmNvbnN0IG1lcmdpbmdDaGVja1dvcmtlciA9IHtcblx0dGltZU91dDogMzAwMCxcblx0dGltZU91dEhhbmRsZTogJycsXG5cdGVycm9yQ291bnRzOiAwLFxuXHQkcHJvZ3Jlc3NCYXJMYWJlbDogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKS5maW5kKCcubGFiZWwnKSxcblx0ZmlsZUlEOiBudWxsLFxuXHRmaWxlUGF0aDogJycsXG5cdGluaXRpYWxpemUoZmlsZUlELCBmaWxlUGF0aCkge1xuXHRcdC8vINCX0LDQv9GD0YHRgtC40Lwg0L7QsdC90L7QstC70LXQvdC40LUg0YHRgtCw0YLRg9GB0LAg0L/RgNC+0LLQsNC50LTQtdGA0LBcblx0XHRtZXJnaW5nQ2hlY2tXb3JrZXIuZmlsZUlEID0gZmlsZUlEO1xuXHRcdG1lcmdpbmdDaGVja1dvcmtlci5maWxlUGF0aCA9IGZpbGVQYXRoO1xuXHRcdG1lcmdpbmdDaGVja1dvcmtlci5yZXN0YXJ0V29ya2VyKGZpbGVJRCk7XG5cdH0sXG5cdHJlc3RhcnRXb3JrZXIoKSB7XG5cdFx0d2luZG93LmNsZWFyVGltZW91dChtZXJnaW5nQ2hlY2tXb3JrZXIudGltZW91dEhhbmRsZSk7XG5cdFx0bWVyZ2luZ0NoZWNrV29ya2VyLndvcmtlcigpO1xuXHR9LFxuXHR3b3JrZXIoKSB7XG5cdFx0UGJ4QXBpLlN5c3RlbUdldFN0YXR1c1VwbG9hZEZpbGUobWVyZ2luZ0NoZWNrV29ya2VyLmZpbGVJRCwgbWVyZ2luZ0NoZWNrV29ya2VyLmNiQWZ0ZXJSZXNwb25zZSk7XG5cdFx0bWVyZ2luZ0NoZWNrV29ya2VyLnRpbWVvdXRIYW5kbGUgPSB3aW5kb3cuc2V0VGltZW91dChcblx0XHRcdG1lcmdpbmdDaGVja1dvcmtlci53b3JrZXIsXG5cdFx0XHRtZXJnaW5nQ2hlY2tXb3JrZXIudGltZU91dCxcblx0XHQpO1xuXHR9LFxuXHRjYkFmdGVyUmVzcG9uc2UocmVzcG9uc2UpIHtcblx0XHRpZiAobWVyZ2luZ0NoZWNrV29ya2VyLmVycm9yQ291bnRzID4gMTApIHtcblx0XHRcdG1lcmdpbmdDaGVja1dvcmtlci4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3IpO1xuXHRcdFx0VXNlck1lc3NhZ2Uuc2hvd0Vycm9yKGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3IpO1xuXHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdHdpbmRvdy5jbGVhclRpbWVvdXQobWVyZ2luZ0NoZWNrV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdH1cblx0XHRpZiAocmVzcG9uc2UgPT09IHVuZGVmaW5lZCB8fCBPYmplY3Qua2V5cyhyZXNwb25zZSkubGVuZ3RoID09PSAwKSB7XG5cdFx0XHRtZXJnaW5nQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgKz0gMTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0aWYgKHJlc3BvbnNlLmRfc3RhdHVzID09PSAnVVBMT0FEX0NPTVBMRVRFJykge1xuXHRcdFx0bWVyZ2luZ0NoZWNrV29ya2VyLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9JbnN0YWxsYXRpb25JblByb2dyZXNzKTtcblx0XHRcdFBieEFwaS5TeXN0ZW1JbnN0YWxsTW9kdWxlKG1lcmdpbmdDaGVja1dvcmtlci5maWxlUGF0aCwgbWVyZ2luZ0NoZWNrV29ya2VyLmNiQWZ0ZXJNb2R1bGVJbnN0YWxsKTtcblx0XHRcdHdpbmRvdy5jbGVhclRpbWVvdXQobWVyZ2luZ0NoZWNrV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdH0gZWxzZSBpZiAocmVzcG9uc2UuZF9zdGF0dXMgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0bWVyZ2luZ0NoZWNrV29ya2VyLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRJblByb2dyZXNzKTtcblx0XHRcdG1lcmdpbmdDaGVja1dvcmtlci5lcnJvckNvdW50cyA9IDA7XG5cdFx0fSBlbHNlIHtcblx0XHRcdG1lcmdpbmdDaGVja1dvcmtlci5lcnJvckNvdW50cyArPSAxO1xuXHRcdH1cblx0fSxcblx0Y2JBZnRlck1vZHVsZUluc3RhbGwocmVzcG9uc2Upe1xuXHRcdGlmIChyZXNwb25zZT09PXRydWUpe1xuXHRcdFx0d2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRVc2VyTWVzc2FnZS5zaG93RXJyb3IoZ2xvYmFsVHJhbnNsYXRlLmV4dF9JbnN0YWxsYXRpb25FcnJvcik7XG5cdFx0fVxuXHR9LFxufTtcblxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuXHRhZGROZXdFeHRlbnNpb24uaW5pdGlhbGl6ZSgpO1xufSk7XG4iXX0=