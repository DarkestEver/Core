"use strict";

/*
 * Copyright (C) MIKO LLC - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Nikolay Beketov, 12 2019
 *
 */

/* global UserMessage, globalTranslate, PbxApi, upgradeStatusLoopWorker */
var addNewExtension = {
  $uploadButton: $('#add-new-button'),
  $progressBar: $('#upload-progress-bar'),
  $progressBarLabel: $('#upload-progress-bar').find('.label'),
  uploadInProgress: false,
  initialize: function () {
    function initialize() {
      addNewExtension.$progressBar.hide();
      addNewExtension.$uploadButton.on('click', function (e) {
        e.preventDefault();

        if (addNewExtension.$uploadButton.hasClass('loading') || addNewExtension.uploadInProgress) {
          return;
        }

        $('input:file', $(e.target).parents()).click();
      });
      $('input:file').on('change', function (e) {
        if (e.target.files[0] !== undefined) {
          addNewExtension.$progressBar.show();
          var filename = e.target.files[0].name;
          $('input:text', $(e.target).parent()).val(filename);
          addNewExtension.uploadInProgress = true;
          addNewExtension.$uploadButton.addClass('loading');
          var data = $('input:file')[0].files[0];
          PbxApi.SystemUploadModule(data, addNewExtension.cbAfterUploadFile);
        }
      });
    }

    return initialize;
  }(),
  cbAfterUploadFile: function () {
    function cbAfterUploadFile(response, success) {
      if (response.length === 0 || response === false || success === false) {
        addNewExtension.$uploadButton.removeClass('loading');
        addNewExtension.uploadInProgress = false;
        UserMessage.showError(globalTranslate.ext_UploadError);
      } else if (response["function"] === 'upload_progress' && success) {
        addNewExtension.$progressBar.progress({
          percent: parseInt(response.percent, 10)
        });

        if (response.percent < 100) {
          addNewExtension.$progressBarLabel.text(globalTranslate.ext_UploadInProgress);
        } else {
          addNewExtension.$progressBarLabel.text(globalTranslate.ext_InstallationInProgress);
        }
      } else if (response["function"] === 'upload' && success) {
        upgradeStatusLoopWorker.initialize(response.uniqid, false);
      } else {
        UserMessage.showMultiString(response.message);
      }
    }

    return cbAfterUploadFile;
  }()
};
$(document).ready(function () {
  addNewExtension.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWFkZC1uZXcuanMiXSwibmFtZXMiOlsiYWRkTmV3RXh0ZW5zaW9uIiwiJHVwbG9hZEJ1dHRvbiIsIiQiLCIkcHJvZ3Jlc3NCYXIiLCIkcHJvZ3Jlc3NCYXJMYWJlbCIsImZpbmQiLCJ1cGxvYWRJblByb2dyZXNzIiwiaW5pdGlhbGl6ZSIsImhpZGUiLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImhhc0NsYXNzIiwidGFyZ2V0IiwicGFyZW50cyIsImNsaWNrIiwiZmlsZXMiLCJ1bmRlZmluZWQiLCJzaG93IiwiZmlsZW5hbWUiLCJuYW1lIiwicGFyZW50IiwidmFsIiwiYWRkQ2xhc3MiLCJkYXRhIiwiUGJ4QXBpIiwiU3lzdGVtVXBsb2FkTW9kdWxlIiwiY2JBZnRlclVwbG9hZEZpbGUiLCJyZXNwb25zZSIsInN1Y2Nlc3MiLCJsZW5ndGgiLCJyZW1vdmVDbGFzcyIsIlVzZXJNZXNzYWdlIiwic2hvd0Vycm9yIiwiZ2xvYmFsVHJhbnNsYXRlIiwiZXh0X1VwbG9hZEVycm9yIiwicHJvZ3Jlc3MiLCJwZXJjZW50IiwicGFyc2VJbnQiLCJ0ZXh0IiwiZXh0X1VwbG9hZEluUHJvZ3Jlc3MiLCJleHRfSW5zdGFsbGF0aW9uSW5Qcm9ncmVzcyIsInVwZ3JhZGVTdGF0dXNMb29wV29ya2VyIiwidW5pcWlkIiwic2hvd011bHRpU3RyaW5nIiwibWVzc2FnZSIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7O0FBUUE7QUFFQSxJQUFNQSxlQUFlLEdBQUc7QUFDdkJDLEVBQUFBLGFBQWEsRUFBRUMsQ0FBQyxDQUFDLGlCQUFELENBRE87QUFFdkJDLEVBQUFBLFlBQVksRUFBRUQsQ0FBQyxDQUFDLHNCQUFELENBRlE7QUFHdkJFLEVBQUFBLGlCQUFpQixFQUFFRixDQUFDLENBQUMsc0JBQUQsQ0FBRCxDQUEwQkcsSUFBMUIsQ0FBK0IsUUFB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LFFBQVEsWUFBUixLQUFzQixRQUF0QixJQUFrQ0MsT0FBdEMsRUFBK0M7QUFDckRhLFFBQUFBLHVCQUF1QixDQUFDbkMsVUFBeEIsQ0FBbUNxQixRQUFRLENBQUNlLE1BQTVDLEVBQW9ELEtBQXBEO0FBQ0EsT0FGTSxNQUVBO0FBQ05YLFFBQUFBLFdBQVcsQ0FBQ1ksZUFBWixDQUE0QmhCLFFBQVEsQ0FBQ2lCLE9BQXJDO0FBQ0E7QUFDRDs7QUEvQ3NCO0FBQUE7QUFBQSxDQUF4QjtBQWtEQTNDLENBQUMsQ0FBQzRDLFFBQUQsQ0FBRCxDQUFZQyxLQUFaLENBQWtCLFlBQU07QUFDdkIvQyxFQUFBQSxlQUFlLENBQUNPLFVBQWhCO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKEMpIE1JS08gTExDIC0gQWxsIFJpZ2h0cyBSZXNlcnZlZFxuICogVW5hdXRob3JpemVkIGNvcHlpbmcgb2YgdGhpcyBmaWxlLCB2aWEgYW55IG1lZGl1bSBpcyBzdHJpY3RseSBwcm9oaWJpdGVkXG4gKiBQcm9wcmlldGFyeSBhbmQgY29uZmlkZW50aWFsXG4gKiBXcml0dGVuIGJ5IE5pa29sYXkgQmVrZXRvdiwgMTIgMjAxOVxuICpcbiAqL1xuXG4vKiBnbG9iYWwgVXNlck1lc3NhZ2UsIGdsb2JhbFRyYW5zbGF0ZSwgUGJ4QXBpLCB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlciAqLyBcblxuY29uc3QgYWRkTmV3RXh0ZW5zaW9uID0ge1xuXHQkdXBsb2FkQnV0dG9uOiAkKCcjYWRkLW5ldy1idXR0b24nKSxcblx0JHByb2dyZXNzQmFyOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhcicpLFxuXHQkcHJvZ3Jlc3NCYXJMYWJlbDogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKS5maW5kKCcubGFiZWwnKSxcblx0dXBsb2FkSW5Qcm9ncmVzczogZmFsc2UsXG5cdGluaXRpYWxpemUoKSB7XG5cdFx0YWRkTmV3RXh0ZW5zaW9uLiRwcm9ncmVzc0Jhci5oaWRlKCk7XG5cdFx0YWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24ub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdGlmIChcblx0XHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24uaGFzQ2xhc3MoJ2xvYWRpbmcnKVxuXHRcdFx0XHR8fCBhZGROZXdFeHRlbnNpb24udXBsb2FkSW5Qcm9ncmVzc1xuXHRcdFx0KSB7IHJldHVybjsgfVxuXHRcdFx0JCgnaW5wdXQ6ZmlsZScsICQoZS50YXJnZXQpLnBhcmVudHMoKSkuY2xpY2soKTtcblx0XHR9KTtcblxuXHRcdCQoJ2lucHV0OmZpbGUnKS5vbignY2hhbmdlJywgKGUpID0+IHtcblx0XHRcdGlmIChlLnRhcmdldC5maWxlc1swXSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdGFkZE5ld0V4dGVuc2lvbi4kcHJvZ3Jlc3NCYXIuc2hvdygpO1xuXHRcdFx0XHRjb25zdCBmaWxlbmFtZSA9IGUudGFyZ2V0LmZpbGVzWzBdLm5hbWU7XG5cdFx0XHRcdCQoJ2lucHV0OnRleHQnLCAkKGUudGFyZ2V0KS5wYXJlbnQoKSkudmFsKGZpbGVuYW1lKTtcblx0XHRcdFx0YWRkTmV3RXh0ZW5zaW9uLnVwbG9hZEluUHJvZ3Jlc3MgPSB0cnVlO1xuXHRcdFx0XHRhZGROZXdFeHRlbnNpb24uJHVwbG9hZEJ1dHRvbi5hZGRDbGFzcygnbG9hZGluZycpO1xuXHRcdFx0XHRjb25zdCBkYXRhID0gJCgnaW5wdXQ6ZmlsZScpWzBdLmZpbGVzWzBdO1xuXHRcdFx0XHRQYnhBcGkuU3lzdGVtVXBsb2FkTW9kdWxlKGRhdGEsIGFkZE5ld0V4dGVuc2lvbi5jYkFmdGVyVXBsb2FkRmlsZSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH0sXG5cdGNiQWZ0ZXJVcGxvYWRGaWxlKHJlc3BvbnNlLCBzdWNjZXNzKSB7XG5cdFx0aWYgKHJlc3BvbnNlLmxlbmd0aCA9PT0gMCB8fCByZXNwb25zZSA9PT0gZmFsc2UgfHwgc3VjY2VzcyA9PT0gZmFsc2UpIHtcblx0XHRcdGFkZE5ld0V4dGVuc2lvbi4kdXBsb2FkQnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHRhZGROZXdFeHRlbnNpb24udXBsb2FkSW5Qcm9ncmVzcyA9IGZhbHNlO1xuXHRcdFx0VXNlck1lc3NhZ2Uuc2hvd0Vycm9yKGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3IpO1xuXHRcdH0gZWxzZSBpZiAocmVzcG9uc2UuZnVuY3Rpb24gPT09ICd1cGxvYWRfcHJvZ3Jlc3MnICYmIHN1Y2Nlc3MpIHtcblx0XHRcdGFkZE5ld0V4dGVuc2lvbi4kcHJvZ3Jlc3NCYXIucHJvZ3Jlc3Moe1xuXHRcdFx0XHRwZXJjZW50OiBwYXJzZUludChyZXNwb25zZS5wZXJjZW50LCAxMCksXG5cdFx0XHR9KTtcblx0XHRcdGlmIChyZXNwb25zZS5wZXJjZW50IDwgMTAwKSB7XG5cdFx0XHRcdGFkZE5ld0V4dGVuc2lvbi4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkSW5Qcm9ncmVzcyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRhZGROZXdFeHRlbnNpb24uJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkluUHJvZ3Jlc3MpO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSBpZiAocmVzcG9uc2UuZnVuY3Rpb24gPT09ICd1cGxvYWQnICYmIHN1Y2Nlc3MpIHtcblx0XHRcdHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLmluaXRpYWxpemUocmVzcG9uc2UudW5pcWlkLCBmYWxzZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhyZXNwb25zZS5tZXNzYWdlKTtcblx0XHR9XG5cdH0sXG59O1xuXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG5cdGFkZE5ld0V4dGVuc2lvbi5pbml0aWFsaXplKCk7XG59KTtcbiJdfQ==